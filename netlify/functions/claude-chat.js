// netlify/functions/claude-chat.js - Complete Options Trading Focused Version
exports.handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      headers,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }

  try {
    const { message } = JSON.parse(event.body);
    
    if (!message) {
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Message required' })
      };
    }

    // Enhanced options trading detection
    const query = message.toLowerCase();
    const tickerMatches = message.match(/\b[A-Z]{1,5}\b/g) || [];
    const isOptionsQuery = query.includes('call') || query.includes('put') || query.includes('option') || 
                          query.includes('strike') || query.includes('expiry') || query.includes('dte') ||
                          query.includes('premium') || query.includes('delta') || query.includes('theta') ||
                          query.includes('gamma') || query.includes('vega') || query.includes('iv') ||
                          query.includes('spread') || query.includes('straddle') || query.includes('strangle');
    
    let response = '';

    // Enhanced ticker analysis with options focus
    if (tickerMatches.length > 0) {
      const ticker = tickerMatches[0];
      
      if (isOptionsQuery) {
        response = `‚ö° **${ticker} OPTIONS ANALYSIS:**

üéØ **Options Opportunities for ${ticker}:**

**üìä Current Setup Analysis:**
‚Ä¢ **Implied Volatility (IV)**: Check if ${ticker} options are cheap or expensive
‚Ä¢ **Earnings Date**: Any upcoming catalyst that could spike IV?
‚Ä¢ **Technical Levels**: Key support/resistance for strike selection
‚Ä¢ **Volume**: Is there institutional options flow in ${ticker}?
‚Ä¢ **Trend**: Bullish/bearish bias for directional plays

**üöÄ Strategy Considerations for ${ticker}:**

**For Bullish Outlook:**
‚Ä¢ **Call Options**: ITM for high delta, OTM for leverage
‚Ä¢ **Bull Call Spreads**: Limit risk while maintaining upside
‚Ä¢ **Covered Calls**: If you own shares, sell calls for income

**For Bearish Outlook:**
‚Ä¢ **Put Options**: Protective puts or speculative puts
‚Ä¢ **Bear Put Spreads**: Defined risk bearish play
‚Ä¢ **Cash-Secured Puts**: Get paid to wait for lower entry

**For Neutral/Range-Bound:**
‚Ä¢ **Iron Condors**: Profit from low volatility
‚Ä¢ **Straddles/Strangles**: Bet on big moves (buy before earnings)
‚Ä¢ **Butterflies**: Profit from price staying near strike

**‚ö° Risk Management for ${ticker} Options:**
‚Ä¢ **Position Size**: Never risk more than 2-5% on single options play
‚Ä¢ **Time Decay**: Avoid buying options with <7 DTE unless scalping
‚Ä¢ **IV Crush**: Be careful buying options before earnings
‚Ä¢ **Delta Hedging**: Consider underlying stock movements

**üí° Next Steps:**
1. Check ${ticker}'s options chain for volume and open interest
2. Look at the Greeks for your preferred strikes
3. Consider market conditions and overall trend
4. Set profit targets (50-100% gains) and stop losses (50% loss)

**What specific ${ticker} options strategy are you considering?** Calls, puts, or something more complex? And what's your market outlook? üìà`;
      } else {
        // Regular stock analysis but with options perspective
        response = `üìà **${ticker} Analysis (Options Trader Perspective):**

üîç **${ticker} Stock Analysis for Options Trading:**

**üìä Key Metrics for Options Plays:**
‚Ä¢ **Current Price Action**: Is ${ticker} trending, consolidating, or breaking out?
‚Ä¢ **Volume Profile**: High volume = better options liquidity
‚Ä¢ **Volatility**: Recent price swings affect options pricing
‚Ä¢ **Support/Resistance**: Critical for strike price selection
‚Ä¢ **Earnings Date**: Major catalyst that affects all options strategies

**‚ö° Options Trading Considerations:**
‚Ä¢ **IV Environment**: Are ${ticker} options expensive or cheap right now?
‚Ä¢ **Liquidity Check**: Tight bid-ask spreads = easier entry/exit
‚Ä¢ **Open Interest**: High OI = more liquid options markets
‚Ä¢ **Pin Risk**: Be aware of weekly expiration effects

**üéØ Strategy Ideas for ${ticker}:**
‚Ä¢ **Trending Up**: Consider call options or bull spreads
‚Ä¢ **Trending Down**: Put options or bear spreads
‚Ä¢ **Range-Bound**: Iron condors or butterflies
‚Ä¢ **High IV**: Sell premium (covered calls, cash-secured puts)
‚Ä¢ **Low IV**: Buy options before potential catalysts

**üìÖ Time Frame Considerations:**
‚Ä¢ **0-3 DTE**: High risk/reward scalping plays
‚Ä¢ **1-2 weeks**: Swing trading with weekly options
‚Ä¢ **30-45 DTE**: Higher probability theta plays

**üí° For the most accurate ${ticker} options analysis, check:**
1. Current IV percentile vs historical
2. Upcoming earnings or news catalysts  
3. Technical support/resistance levels
4. Options flow and unusual activity

**What's your ${ticker} options strategy? Looking for directional plays, income generation, or volatility trades?** üéØ`;
      }
    }
    // Covered Calls Strategy
    else if (query.includes('covered call')) {
      response = `‚ö° **COVERED CALLS MASTERY:**

üéØ **Strategy Overview:**
Own 100 shares + sell call option against them. Collect premium while capping upside. Perfect for neutral-to-slightly-bullish outlook on stocks you already own.

**üìä When to Use Covered Calls:**
‚Ä¢ You own stock and want to generate income
‚Ä¢ Stock is range-bound or slightly bullish
‚Ä¢ IV is elevated (good premium collection)
‚Ä¢ You're okay with potentially selling shares

**üöÄ Optimal Setup:**
‚Ä¢ **Time Frame**: 30-45 DTE for best theta decay
‚Ä¢ **Strike Selection**: 15-30 delta (usually OTM)
‚Ä¢ **IV Environment**: Sell when IV >50th percentile
‚Ä¢ **Timing**: Sell on green days, avoid before earnings

**‚ö° Risk Management:**
‚Ä¢ **Max Loss**: Stock purchase price minus premium collected
‚Ä¢ **Assignment Risk**: Be prepared to sell shares at strike
‚Ä¢ **Rolling Strategy**: Roll up and out if stock breaks above strike
‚Ä¢ **Stop Loss**: Consider if stock drops >10-15%

**üí° Pro Tips:**
‚Ä¢ Target 1-2% monthly returns (12-24% annually)
‚Ä¢ Sell calls on bounces, not dips
‚Ä¢ Consider LEAPS for synthetic covered calls (lower capital)
‚Ä¢ Track your "yield on cost" vs dividends

**üéØ Best Stocks for Covered Calls:**
‚Ä¢ High IV stocks (TSLA, NVDA, AMD)
‚Ä¢ Dividend aristocrats (KO, JNJ, PG)
‚Ä¢ Large-cap with good liquidity (AAPL, MSFT, GOOGL)

**What stocks are you considering for covered calls? I can help analyze the setup!** üìà`;
    }
    // Cash-Secured Puts Strategy
    else if (query.includes('cash secured put') || query.includes('csp')) {
      response = `‚ö° **CASH-SECURED PUTS STRATEGY:**

üéØ **Strategy Overview:**
Set aside 100% cash + sell put option. Get paid premium to potentially buy stock at discount. Perfect "get paid to wait" strategy for stocks you want to own.

**üìä When to Use CSPs:**
‚Ä¢ Want to own stock but at lower price
‚Ä¢ Bullish long-term but patient on entry
‚Ä¢ High IV environment (good premium)
‚Ä¢ Strong support level to sell puts against

**üöÄ Optimal Setup:**
‚Ä¢ **Strike Selection**: Below strong technical support
‚Ä¢ **Time Frame**: 30-45 DTE for optimal risk/reward
‚Ä¢ **Cash Requirement**: Strike price √ó 100 shares
‚Ä¢ **Target**: 1-3% monthly returns

**‚ö° Best Market Conditions:**
‚Ä¢ **Sell on Red Days**: When fear is high, premiums rich
‚Ä¢ **High IV**: VIX >20, individual stock IV elevated
‚Ä¢ **Support Levels**: Place strikes at key technical levels
‚Ä¢ **Quality Stocks**: Only sell puts on stocks you'd love to own

**üõ°Ô∏è Risk Management:**
‚Ä¢ **Max Loss**: Strike price minus premium received
‚Ä¢ **Assignment**: Be HAPPY to own the stock at that price
‚Ä¢ **Rolling**: Roll down and out if stock falls below strike
‚Ä¢ **Capital**: Only use 20-30% of account for CSPs

**üí° Pro Strategy - The Wheel:**
1. Sell cash-secured put
2. If assigned, own the stock
3. Sell covered calls against the shares
4. If called away, back to step 1
5. Collect premium every step of the way

**üéØ Best Stocks for CSPs:**
‚Ä¢ Quality companies you'd hold long-term
‚Ä¢ Strong support levels visible on charts
‚Ä¢ High IV but not "meme stock" crazy
‚Ä¢ Examples: AAPL, MSFT, GOOGL at support

**Which stocks are you eyeing for cash-secured puts? Let's find the perfect strikes!** üí∞`;
    }
    // Iron Condors Strategy
    else if (query.includes('iron condor')) {
      response = `‚ö° **IRON CONDORS - INCOME MACHINE:**

üéØ **Strategy Overview:**
Sell put spread + sell call spread simultaneously. Profit from low volatility and time decay. Best neutral strategy for range-bound markets.

**üìä Iron Condor Structure:**
‚Ä¢ **Sell Put**: Lower strike (bullish assumption)
‚Ä¢ **Buy Put**: Even lower strike (protection)
‚Ä¢ **Sell Call**: Higher strike (bearish assumption)  
‚Ä¢ **Buy Call**: Even higher strike (protection)
‚Ä¢ **Sweet Spot**: Stock stays between short strikes

**üöÄ Optimal Market Conditions:**
‚Ä¢ **High IV Environment**: VIX >20, elevated option premiums
‚Ä¢ **Range-Bound Market**: Sideways or choppy price action
‚Ä¢ **Low Movement Expected**: No major catalysts coming
‚Ä¢ **30-45 DTE**: Optimal time for theta decay

**‚ö° Setup Guidelines:**
‚Ä¢ **Width**: 5-10 point spreads for good risk/reward
‚Ä¢ **Probability**: Target 16-20 delta short strikes
‚Ä¢ **Credit**: Aim for 1/3 of spread width in premium
‚Ä¢ **Liquidity**: Only trade liquid underlyings (SPY, QQQ, AAPL)

**üõ°Ô∏è Risk Management Rules:**
‚Ä¢ **Close at 50% Max Profit**: Don't get greedy
‚Ä¢ **Stop Loss**: 200% of credit received OR 50% of spread width
‚Ä¢ **Early Management**: Adjust winners before losers
‚Ä¢ **Avoid Earnings**: Close before any major announcements

**üí° Advanced Iron Condor Tips:**
‚Ä¢ **SPY/QQQ**: Most liquid, tight spreads
‚Ä¢ **Weekly Cycles**: Can trade every week for income
‚Ä¢ **Volatility Timing**: Enter when VIX spikes >25
‚Ä¢ **Win Rate**: Target 70-80% win rate, small consistent profits

**üìä Example Trade:**
SPY at $580:
‚Ä¢ Sell 575 Put / Buy 570 Put (5-point spread)
‚Ä¢ Sell 585 Call / Buy 590 Call (5-point spread)
‚Ä¢ Collect $2.00 credit, risk $3.00
‚Ä¢ Profit if SPY stays between 575-585

**Ready to build an iron condor? Give me a ticker and I'll structure the perfect setup!** ü¶Ö`;
    }
    // 0DTE Trading
    else if (query.includes('0dte') || query.includes('0 dte')) {
      response = `‚ö° **0DTE TRADING - ULTIMATE SCALPING:**

üéØ **0DTE Overview:**
Options expiring same day. Highest risk/reward in options trading. Pure gamma scalping requiring lightning-fast decisions and iron discipline.

**üöÄ Why 0DTE Works:**
‚Ä¢ **Massive Gamma**: Small stock moves = huge option moves
‚Ä¢ **Pure Direction**: No time value, just intrinsic movement
‚Ä¢ **Speed**: Quick profits (or losses) within hours/minutes
‚Ä¢ **Liquidity**: SPY/QQQ have incredible 0DTE volume

**‚ö° Optimal Conditions for 0DTE:**
‚Ä¢ **Final 2 Hours**: 2-4 PM EST when gamma peaks
‚Ä¢ **Trending Markets**: Strong directional bias needed
‚Ä¢ **High Volume**: Institutional activity driving moves
‚Ä¢ **Technical Levels**: Major support/resistance breaks

**üéØ Best 0DTE Setups:**
‚Ä¢ **ATM Calls/Puts**: Maximum gamma exposure
‚Ä¢ **Breakout Plays**: Buy calls on resistance breaks
‚Ä¢ **Reversal Plays**: Puts on failed breakouts
‚Ä¢ **Scalping**: Quick 20-50% gains, cut losses fast

**üõ°Ô∏è Critical Risk Management:**
‚Ä¢ **Position Size**: NEVER more than 1% of account
‚Ä¢ **Stop Loss**: -50% immediately, no exceptions
‚Ä¢ **Profit Target**: 50-100% gains, take it and run
‚Ä¢ **Time Limit**: Close all positions by 3:50 PM

**‚ö° 0DTE Psychology Rules:**
‚Ä¢ **No Emotions**: Mechanical execution only
‚Ä¢ **Accept Losses**: Most trades will lose money
‚Ä¢ **Small Size**: Survive to fight another day
‚Ä¢ **Quick Decisions**: Hesitation kills 0DTE profits

**üí° Advanced 0DTE Strategies:**
‚Ä¢ **Call Spreads**: Limit risk while maintaining upside
‚Ä¢ **Put Spreads**: Defined risk on market drops
‚Ä¢ **Straddles**: Big move plays before close
‚Ä¢ **Momentum Following**: Trade with the trend

**üìä Example 0DTE Setup:**
SPY at 580 at 2 PM:
‚Ä¢ Buy 580 calls if breaking resistance
‚Ä¢ Risk: $100 per contract
‚Ä¢ Target: $200-300 per contract (100-200% gain)
‚Ä¢ Stop: $50 per contract (-50% loss)
‚Ä¢ Time Limit: Close by 3:45 PM no matter what

**‚ö†Ô∏è 0DTE Reality Check:**
‚Ä¢ This is gambling, not investing
‚Ä¢ Most retail traders lose money
‚Ä¢ Requires extensive practice
‚Ä¢ Start with paper trading first

**Want to learn 0DTE? I can teach you the mechanics, but promise me you'll start small!** ‚ö°`;
    }
    // Greeks Education
    else if (query.includes('delta') || query.includes('gamma') || query.includes('theta') || query.includes('vega') || query.includes('greeks')) {
      response = `‚ö° **THE GREEKS - YOUR OPTIONS SUPERPOWERS:**

üöÄ **Master These 4 Greeks to Win:**

**üî∏ DELTA - Direction & Speed**
‚Ä¢ **What**: How much option price moves per $1 stock move
‚Ä¢ **Call Delta**: 0 to 1.00 (0.50 = 50¬¢ move per $1 stock move)
‚Ä¢ **Put Delta**: 0 to -1.00 (-0.30 = 30¬¢ gain per $1 stock drop)
‚Ä¢ **Sweet Spot**: 0.40-0.70 for directional plays
‚Ä¢ **Pro Tip**: Higher delta = more expensive but safer

**üî∏ THETA - Time Decay (Your Enemy/Friend)**
‚Ä¢ **What**: Daily time decay stealing option value
‚Ä¢ **Impact**: Accelerates in final 30 days to expiration
‚Ä¢ **Strategy**: Sell options to COLLECT theta (covered calls, CSPs)
‚Ä¢ **Timing**: Avoid buying options with <7 DTE
‚Ä¢ **Weekend Effect**: 3 days of theta decay over weekends

**üî∏ GAMMA - Acceleration Power**
‚Ä¢ **What**: How fast delta changes as stock moves
‚Ä¢ **Peak**: ATM options have highest gamma
‚Ä¢ **Risk**: Can create explosive moves near expiration
‚Ä¢ **0DTE**: Gamma goes ballistic on expiration day
‚Ä¢ **Strategy**: Buy gamma before big moves, sell after

**üî∏ VEGA - Volatility Sensitivity**
‚Ä¢ **What**: How much option price changes per 1% IV move
‚Ä¢ **Earnings**: High vega = huge IV crush after announcement
‚Ä¢ **Buy Low IV**: Before known catalysts or market stress
‚Ä¢ **Sell High IV**: When everyone's panicking (VIX >30)
‚Ä¢ **Long-term**: LEAPS have highest vega exposure

**‚ö° Greeks in Action - Real Examples:**

**Buying Calls (You Want):**
‚Ä¢ High Delta (0.60+): More stock-like movement
‚Ä¢ Low Theta: Minimal daily decay
‚Ä¢ Low Vega: Less sensitive to IV changes
‚Ä¢ Moderate Gamma: Acceleration on your side

**Selling Covered Calls (You Want):**
‚Ä¢ Low Delta (0.15-0.30): Lower chance of assignment
‚Ä¢ High Theta: Fast time decay in your favor
‚Ä¢ High Vega: Benefit from IV crush
‚Ä¢ Low Gamma: Less acceleration against you

**üéØ Advanced Greeks Strategies:**
‚Ä¢ **Delta Hedging**: Buy/sell shares to neutralize delta
‚Ä¢ **Gamma Scalping**: Profit from gamma acceleration
‚Ä¢ **Theta Farming**: Consistent income from time decay
‚Ä¢ **Vega Trading**: Buy low IV, sell high IV

**üí° Greeks Monitoring Tools:**
‚Ä¢ Most brokers show Greeks in options chains
‚Ä¢ Focus on total portfolio Greeks, not individual trades
‚Ä¢ Watch how Greeks change with time and price moves
‚Ä¢ Use Greeks to size positions appropriately

**Which Greek do you want to master first? I can dive deeper into any of them!** üìä`;
    }
    // Earnings Plays
    else if (query.includes('earnings') && isOptionsQuery) {
      response = `‚ö° **EARNINGS OPTIONS STRATEGIES:**

üéØ **The Earnings Volatility Game:**
Earnings = biggest catalyst for individual stocks. Massive opportunities but requires understanding IV crush and timing.

**üìä Pre-Earnings Setup (1-2 weeks before):**
‚Ä¢ **IV Crush Coming**: Options prices will collapse after earnings
‚Ä¢ **Buy Strategies**: Straddles, strangles, calls/puts (directional)
‚Ä¢ **Sell Strategies**: Iron condors, covered calls (collect high premium)
‚Ä¢ **Timing**: Enter 1-2 weeks before, exit day before earnings

**üöÄ Earnings Strategy Menu:**

**üî∏ LONG STRADDLE (Big Move Expected):**
‚Ä¢ Buy ATM call + ATM put
‚Ä¢ Profit from move >total premium paid
‚Ä¢ Best: When IV is low before earnings run-up
‚Ä¢ Risk: IV crush if move isn't big enough

**üî∏ SHORT IRON CONDOR (Range-Bound):**
‚Ä¢ Sell put spread + call spread
‚Ä¢ Profit if stock stays within strikes post-earnings
‚Ä¢ Best: High IV environment, stable companies
‚Ä¢ Risk: Unexpected huge move breaks your strikes

**üî∏ DIRECTIONAL PLAYS:**
‚Ä¢ Buy calls if bullish, puts if bearish
‚Ä¢ Use spreads to reduce vega risk
‚Ä¢ Target strikes based on expected move
‚Ä¢ Exit before earnings or hold through

**‚ö° IV Crush Education:**
‚Ä¢ **Before Earnings**: IV inflated (expensive options)
‚Ä¢ **After Earnings**: IV collapses (cheap options)
‚Ä¢ **Impact**: Can lose money even if direction right
‚Ä¢ **Solution**: Sell premium before, buy premium after

**üõ°Ô∏è Earnings Risk Management:**
‚Ä¢ **Position Size**: Max 2-3% per earnings play
‚Ä¢ **Multiple Plays**: Spread across different earnings dates
‚Ä¢ **Exit Strategy**: Take profits before announcement OR hold through
‚Ä¢ **Paper Trade**: Practice timing and strategy selection

**üí° Advanced Earnings Techniques:**
‚Ä¢ **Calendar Spreads**: Sell front month, buy back month
‚Ä¢ **Ratio Spreads**: Different quantities of options
‚Ä¢ **Synthetic Strategies**: Replicate stock with options
‚Ä¢ **Post-Earnings**: Buy crushed options for next cycle

**üìä Earnings Calendar Priority:**
‚Ä¢ **High IV**: Look for elevated option premiums
‚Ä¢ **Liquid Options**: Tight bid-ask spreads
‚Ä¢ **Historical Moves**: Research past earnings reactions
‚Ä¢ **Analyst Expectations**: Consensus vs whisper numbers

**üéØ This Week's Earnings Plays:**
Which stocks are reporting earnings this week? I can help analyze the best options strategy for each one! üìà`;
    }
    // Market Analysis with Options Focus
    else if (query.includes('market') || query.includes('spy') || query.includes('qqq') || query.includes('vix')) {
      response = `üåä **OPTIONS MARKET ANALYSIS:**

**üìà Current Options Environment:**

**üéØ Key Indices for Options Traders:**
‚Ä¢ **SPY (S&P 500)**: Most liquid options, perfect for beginners
  - Tight spreads, high volume, weekly/daily expirations
‚Ä¢ **QQQ (Nasdaq)**: Tech-heavy, higher volatility = better premiums
  - More explosive moves, great for directional plays
‚Ä¢ **IWM (Russell 2000)**: Small caps, highest volatility
  - Big moves but wider spreads, advanced traders only
‚Ä¢ **VIX**: Fear gauge affecting ALL options pricing

**‚ö° Reading the Volatility Environment:**

**üü¢ Low VIX (<20) - "Greed Mode":**
‚Ä¢ Options are cheap = good time to BUY
‚Ä¢ Market complacent, volatility selling strategies risky
‚Ä¢ Perfect for: Long straddles, call buying, put protection

**üî¥ High VIX (>30) - "Fear Mode":**
‚Ä¢ Options are expensive = good time to SELL
‚Ä¢ Market panicking, premium collection opportunities
‚Ä¢ Perfect for: Covered calls, CSPs, iron condors

**üü° Medium VIX (20-30) - "Normal Mode":**
‚Ä¢ Balanced options pricing
‚Ä¢ Trend-following strategies work best
‚Ä¢ Mix of buying and selling approaches

**üìä Options Flow Indicators:**
‚Ä¢ **Put/Call Ratio >1.0**: Bearish sentiment (contrarian bullish)
‚Ä¢ **SKEW >130**: Fear of black swan events
‚Ä¢ **Term Structure**: Compare 30-day vs 60-day IV
‚Ä¢ **Dark Pool Activity**: Institutional positioning

**üéØ Current Market-Based Strategies:**

**üöÄ Trending Market (Strong Direction):**
‚Ä¢ Buy calls/puts in trend direction
‚Ä¢ Use spreads to reduce cost
‚Ä¢ Trail stops with technical levels
‚Ä¢ Focus on momentum names

**üìà Range-Bound Market (Choppy/Sideways):**
‚Ä¢ Iron condors on SPY/QQQ
‚Ä¢ Covered calls for income
‚Ä¢ Cash-secured puts at support
‚Ä¢ Theta decay strategies

**üå™Ô∏è High Volatility Market (VIX >25):**
‚Ä¢ Sell premium strategies dominate
‚Ä¢ Short straddles/strangles
‚Ä¢ Credit spreads with wide strikes
‚Ä¢ Avoid buying expensive options

**üí° Sector Rotation for Options:**
‚Ä¢ **Tech (QQQ)**: Higher IV, bigger moves
‚Ä¢ **Financial (XLF)**: Interest rate sensitive
‚Ä¢ **Energy (XLE)**: Commodity correlation
‚Ä¢ **Healthcare (XLV)**: Defensive, lower IV

**üìä Weekly Game Plan:**
‚Ä¢ **Monday**: Analyze weekend news, VIX levels
‚Ä¢ **Tuesday-Thursday**: Peak trading, best liquidity
‚Ä¢ **Friday**: Expiration effects, gamma risk
‚Ä¢ **Options Expiration**: Third Friday monthly chaos

**What's your current market outlook? And which timeframe are you trading - daily, weekly, or monthly options?** üéØ`;
    }
    // Risk Management for Options
    else if (query.includes('risk') || query.includes('position size') || query.includes('stop loss')) {
      response = `üõ°Ô∏è **OPTIONS RISK MANAGEMENT MASTERY:**

**üí∞ Position Sizing - The Foundation:**

**üéØ The Options Risk Pyramid:**
‚Ä¢ **Conservative (1-2%)**: Covered calls, CSPs, spreads
‚Ä¢ **Moderate (2-3%)**: Long options, iron condors
‚Ä¢ **Aggressive (3-5%)**: 0DTE, earnings plays, straddles
‚Ä¢ **Speculative (<1%)**: Lottery tickets, YOLO plays

**‚ö° Account Allocation Rules:**
‚Ä¢ **Max 20% in Options**: Never go all-in on options
‚Ä¢ **Max 10% Per Trade**: Single position limits
‚Ä¢ **Max 5% Per Expiration**: Spread risk across time
‚Ä¢ **Cash Reserves**: Keep 30% for opportunities

**üî∏ Options-Specific Risk Rules:**

**Time Decay Management:**
‚Ä¢ **Don't Buy <7 DTE**: Unless scalping or 0DTE strategy
‚Ä¢ **Sell 30-45 DTE**: Optimal theta decay window
‚Ä¢ **Roll Before 21 DTE**: Avoid gamma risk explosion
‚Ä¢ **Weekend Risk**: 3 days of theta over weekends

**Volatility Risk Control:**
‚Ä¢ **Don't Buy High IV**: >75th percentile = expensive
‚Ä¢ **Sell When IV High**: VIX >25 = premium selling time
‚Ä¢ **IV Crush Protection**: Exit before earnings announcement
‚Ä¢ **Volatility Clustering**: Prepare for continued high/low IV

**üõ°Ô∏è Stop Loss Strategies by Trade Type:**

**üî∏ Long Options (Calls/Puts):**
‚Ä¢ **50% Rule**: Cut losses at 50% of premium paid
‚Ä¢ **Time Stop**: Exit if no movement in first half of DTE
‚Ä¢ **Technical Stop**: Exit if underlying breaks key level
‚Ä¢ **Volatility Stop**: Exit if IV drops significantly

**üî∏ Credit Spreads:**
‚Ä¢ **50% Profit Rule**: Close at 50% of max profit
‚Ä¢ **200% Loss Rule**: Stop loss at 200% of credit received
‚Ä¢ **Early Management**: Close winning side early
‚Ä¢ **Delta Management**: Adjust if delta gets too high

**üî∏ Debit Spreads:**
‚Ä¢ **50% Loss Rule**: Stop at 50% of premium paid
‚Ä¢ **Profit Target**: Close at 75% of max profit
‚Ä¢ **Time Management**: Exit with 30% of time remaining
‚Ä¢ **Technical Exit**: Close if underlying reverses trend

**‚ö° Portfolio Heat Management:**

**Correlation Limits:**
‚Ä¢ **Max 30% in Single Sector**: Avoid tech-heavy blowups
‚Ä¢ **Spread Across Timeframes**: Weekly + monthly exposure
‚Ä¢ **Balance Strategies**: Mix buying + selling approaches
‚Ä¢ **Hedge Positions**: VIX calls during market stress

**Emergency Protocols:**
‚Ä¢ **Market Crash**: Close naked positions immediately
‚Ä¢ **Volatility Spike**: Reassess all short positions
‚Ä¢ **Earnings Disaster**: Don't panic-sell, reassess plan
‚Ä¢ **Personal Stress**: Step away, don't revenge trade

**üéØ Advanced Risk Techniques:**

**Greeks Portfolio Management:**
‚Ä¢ **Total Portfolio Delta**: Keep under ¬±50 for neutrality
‚Ä¢ **Theta Tracking**: Monitor daily decay across all positions
‚Ä¢ **Vega Exposure**: Limit sensitivity to volatility changes
‚Ä¢ **Gamma Risk**: Watch acceleration risk near expiration

**Kelly Criterion for Options:**
‚Ä¢ **Formula**: f = (bp - q) / b
‚Ä¢ **Application**: Size positions based on edge and win rate
‚Ä¢ **Reality**: Most retail traders oversize positions
‚Ä¢ **Conservative**: Use 25% of Kelly suggestion

**üí° Psychological Risk Management:**
‚Ä¢ **Trading Journal**: Track every decision and outcome
‚Ä¢ **Position Limits**: Set before market opens
‚Ä¢ **Emotional Stops**: Walk away when frustrated
‚Ä¢ **Profit Taking**: Lock in gains systematically

**What's your biggest options risk challenge right now? Position sizing, stop losses, or portfolio management?** üí™`;
    }
    // General Options Trading
    else if (isOptionsQuery) {
      response = `‚ö° **OPTIONS TRADING COMMAND CENTER:**

üöÄ **Your Options Toolkit:**

**üìä Strategy Selection Guide:**
‚Ä¢ **Bullish**: Calls, bull spreads, covered calls
‚Ä¢ **Bearish**: Puts, bear spreads, protective puts
‚Ä¢ **Neutral**: Iron condors, butterflies, straddles
‚Ä¢ **Income**: Covered calls, CSPs, theta strategies
‚Ä¢ **Volatility**: Straddles, strangles, calendar spreads

**üéØ Market Environment Strategies:**

**üî∏ Low Volatility (VIX <20):**
‚Ä¢ **Buy Options**: Cheap premiums before volatility expansion
‚Ä¢ **Long Straddles**: Bet on volatility increase
‚Ä¢ **Calendar Spreads**: Benefit from volatility skew
‚Ä¢ **Avoid**: Selling premium (not enough credit)

**üî∏ High Volatility (VIX >25):**
‚Ä¢ **Sell Options**: Rich premiums, high probability wins
‚Ä¢ **Iron Condors**: Range-bound profit from time decay
‚Ä¢ **Covered Calls**: Enhanced income from high IV
‚Ä¢ **Avoid**: Buying expensive options

**‚ö° Time Frame Strategies:**

**üî∏ 0-7 DTE (Scalping):**
‚Ä¢ High risk/reward gamma plays
‚Ä¢ Requires constant monitoring
‚Ä¢ Best for experienced traders
‚Ä¢ ATM options for maximum gamma

**üî∏ 1-4 Weeks (Swing Trading):**
‚Ä¢ Weekly options cycles
‚Ä¢ Good balance of time/premium
‚Ä¢ Technical analysis driven
‚Ä¢ Popular retail timeframe

**üî∏ 30-60 DTE (Probability Trading):**
‚Ä¢ Optimal theta decay window
‚Ä¢ Higher probability strategies
‚Ä¢ Professional trader favorite
‚Ä¢ Best risk/reward balance

**üõ°Ô∏è Risk Management Essentials:**
‚Ä¢ **Position Size**: Never risk more than you can afford to lose
‚Ä¢ **Diversification**: Spread across strikes, expirations, strategies
‚Ä¢ **Profit Taking**: Lock in 50% gains on credit spreads
‚Ä¢ **Loss Cutting**: Stop losses at 50% for debit plays

**üìà Performance Tracking:**
‚Ä¢ **Win Rate**: Target 65-70% for credit strategies
‚Ä¢ **Average Winner**: Should be larger than average loser
‚Ä¢ **Monthly Returns**: Aim for 2-5% consistent growth
‚Ä¢ **Sharpe Ratio**: Risk-adjusted returns matter most

**üéØ Next Level Options:**
‚Ä¢ **Greeks Mastery**: Understand delta, theta, gamma, vega
‚Ä¢ **Volatility Trading**: Buy low IV, sell high IV
‚Ä¢ **Portfolio Management**: Total exposure monitoring
‚Ä¢ **Tax Strategies**: Understand options tax implications

**What specific options topic would you like to dive deeper into?** üìä`;
    }
    // General greeting with options focus
    else if (query.includes('hello') || query.includes('hi') || query.includes('hey') || query.includes('what') && query.includes('up')) {
      response = `üëã **Hey there, options trader! Rolo here!**

‚ö° **Ready to dominate the options market today?**

**üéØ I'm your specialist for:**
‚Ä¢ **Options Strategy Analysis**: Calls, puts, spreads, straddles
‚Ä¢ **Greeks Mastery**: Delta, theta, gamma, vega optimization  
‚Ä¢ **Risk Management**: Position sizing, stop losses, portfolio heat
‚Ä¢ **Volatility Trading**: IV analysis, earnings plays, VIX strategies
‚Ä¢ **Market Analysis**: SPY/QQQ setups, sector rotations
‚Ä¢ **Income Strategies**: Covered calls, CSPs, iron condors

**‚ö° Try these options-focused questions:**
‚Ä¢ *"What's the best AAPL options play right now?"*
‚Ä¢ *"Explain iron condors for weekly income"*
‚Ä¢ *"How do I manage theta decay risk?"*
‚Ä¢ *"Should I buy or sell volatility today?"*
‚Ä¢ *"Help me size this 0DTE trade properly"*

**üöÄ Market Status Check:**
‚Ä¢ What's your outlook - bullish, bearish, or neutral?
‚Ä¢ Any specific tickers on your watchlist today?
‚Ä¢ Looking for income plays or directional bets?

**üí° Pro Tip:** The more specific you are about your setup, market outlook, and risk tolerance, the better I can tailor strategies for your style!

**What's your first options move today?** üìà`;
    }
    // Default response with options focus
    else {
      response = `‚ö° **Rolo - Your Options Trading AI!**

**üöÄ I'm built specifically for OPTIONS TRADERS:**

**üìà What I Excel At:**
‚Ä¢ **Any Ticker Analysis**: Just mention a symbol (AAPL, TSLA, NVDA, etc.) and I'll break down the options opportunities
‚Ä¢ **Strategy Deep Dives**: Covered calls, iron condors, straddles, 0DTE plays
‚Ä¢ **Greeks Education**: Delta, theta, gamma, vega - and how to profit from them
‚Ä¢ **Risk Management**: Position sizing, portfolio heat, stop losses
‚Ä¢ **Market Timing**: When to buy/sell volatility, earnings plays
‚Ä¢ **Income Generation**: Weekly theta strategies, wheel trades

**‚ö° Options-Focused Questions That Work:**
‚Ä¢ *"Best options strategy for [TICKER]?"*
‚Ä¢ *"How do I trade earnings with options?"*
‚Ä¢ *"Explain iron condors vs butterflies"*
‚Ä¢ *"Should I buy this call or sell a put spread?"*
‚Ä¢ *"How do I manage a losing options position?"*

**üéØ Current Market Opportunities:**
‚Ä¢ High IV names for premium selling
‚Ä¢ Low IV setups for volatility buying  
‚Ä¢ Technical levels for strike selection
‚Ä¢ Earnings calendar for catalyst plays

**What specific options challenge can I help you solve today?** üìä`;
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ 
        response: response,
        isLive: true 
      })
    };

  } catch (error) {
    console.error('Claude Function Error:', error);
    
    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ 
        response: `‚ö° Rolo here! Your options trading AI is ready.\n\nTry asking me about:\n‚Ä¢ Any ticker's options opportunities\n‚Ä¢ Greeks and strategy analysis\n‚Ä¢ Risk management for options\n‚Ä¢ Market volatility insights\n\nWhat's your options play today?`,
        isLive: false,
        fallback: true 
      })
    };
  }
};
