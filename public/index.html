<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rolo AI Trading - With Alpaca Integration</title>
    <meta name="description" content="Professional Options Trading Assistant powered by Claude AI, live market data, Discord sentiment, and Alpaca brokerage">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8fafc; 
            -webkit-text-size-adjust: 100%;
        }
        .app { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .header { 
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%); 
            color: white; 
            padding: 1rem; 
            flex-shrink: 0;
            z-index: 10;
        }
        .header h1 { font-size: 1.125rem; margin-bottom: 0.25rem; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 0.8rem; }
        .status-bar { 
            background: #dcfce7; 
            color: #166534; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            flex-shrink: 0;
            z-index: 10;
        }
        .status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; }
        .alpaca-status { 
            background: #fef3c7; 
            color: #92400e; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            flex-shrink: 0;
            z-index: 10;
        }
        .content { 
            flex: 1; 
            padding: 0.5rem; 
            padding-bottom: 8rem;
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            transition: all 0.3s ease;
            min-height: 0;
            max-height: calc(100vh - 220px);
        }
        
        .input-section {
            position: fixed;
            bottom: 4.5rem;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            z-index: 60;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: block;
        }
        
        .scrollable-content {
            padding-bottom: 4rem;
            min-height: 100%;
        }
        
        .page-content {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .page-content.fade-out {
            opacity: 0;
            transform: translateX(-20px);
        }
        .card { 
            background: white; 
            padding: 1rem; 
            margin-bottom: 0.75rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tabs { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(229, 231, 235, 0.5); 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
            padding: 0.5rem;
            height: 4.5rem;
            transition: all 0.3s ease;
        }
        .tab { 
            flex: 1; 
            padding: 0.5rem 0.25rem; 
            text-align: center; 
            cursor: pointer; 
            border: none; 
            background: none; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 0.125rem;
            font-size: 0.7rem;
            color: #6b7280;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 3.5rem;
            border-radius: 0.75rem;
            position: relative;
            transform: scale(1);
        }
        .tab:active { 
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        .tab.active { 
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            color: #7c3aed; 
            font-weight: 600; 
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
            transform: scale(1.02);
        }
        .tab.active::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: #7c3aed;
            border-radius: 1px;
        }
        .tab-icon { font-size: 1.2rem; }
        .tab-label { font-size: 0.65rem; font-weight: 500; }
        
        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #7c3aed;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .input { 
            flex: 1; 
            padding: 0.875rem; 
            border: 2px solid #e2e8f0; 
            border-radius: 0.75rem; 
            outline: none; 
            font-size: 16px;
            background: #fafafa;
        }
        .input:focus { border-color: #7c3aed; background: white; }
        .btn { 
            padding: 0.875rem 1rem; 
            background: #7c3aed; 
            color: white; 
            border: none; 
            border-radius: 0.75rem; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-small { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        
        .messages { 
            height: 45vh;
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto; 
            border: 2px solid #e2e8f0; 
            padding: 0.75rem; 
            margin-bottom: 1rem; 
            border-radius: 0.75rem; 
            background: #fafafa;
            -webkit-overflow-scrolling: touch;
        }
        .message { margin-bottom: 1rem; }
        .message.user { text-align: right; }
        .message-content { 
            display: inline-block; 
            max-width: 85%; 
            padding: 0.75rem 1rem; 
            border-radius: 1rem; 
            line-height: 1.4; 
            white-space: pre-line;
            font-size: 0.9rem;
        }
        .message.user .message-content { background: #7c3aed; color: white; }
        .message.assistant .message-content { background: white; color: #1f2937; border: 1px solid #e2e8f0; }
        .message-meta { font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; }
        
        .alpaca-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .account-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .account-stat {
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        
        .stat-value-large {
            font-size: 1.25rem;
            font-weight: 700;
            color: #059669;
        }
        
        .stat-label { 
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-bottom: 0.25rem; 
            font-weight: 500; 
        }
        
        .error-card {
            background: #fee2e2;
            border: 2px solid #fca5a5;
            border-radius: 0.75rem;
            padding: 1rem;
            color: #dc2626;
            margin-bottom: 1rem;
        }
        
        .success-card {
            background: #dcfce7;
            border: 2px solid #86efac;
            border-radius: 0.75rem;
            padding: 1rem;
            color: #166534;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app">
            <div class="header">
                <h1>🤖 Rolo AI Trading</h1>
                <p>AI Assistant + Live Market Data + Discord Sentiment + Alpaca Brokerage</p>
            </div>
            
            <div class="status-bar">
                <div class="status-dot"></div>
                <span>🟢 Live APIs: Claude AI • Discord Sentiment • Yahoo Finance • Alpha Vantage</span>
            </div>
            
            <div class="alpaca-status" id="alpacaStatus">
                <div class="status-dot" style="background: #f59e0b;"></div>
                <span>🔶 Alpaca: Connecting...</span>
            </div>
            
            <div class="content" id="content">
                <!-- Content will be inserted here -->
            </div>
            
            <div class="input-section" id="inputSection">
                <div class="input-group">
                    <input 
                        type="text" 
                        class="input" 
                        id="messageInput"
                        placeholder="Ask: 'Show my Alpaca portfolio' or 'AAPL options strategy with my buying power'"
                        onkeypress="if(event.key==='Enter') sendMessage()"
                    />
                    <button class="btn" onclick="sendMessage()" id="sendBtn">
                        ➤
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('chat')" id="chat-tab">
                    <div class="tab-icon">💬</div>
                    <div class="tab-label">Chat</div>
                </button>
                <button class="tab" onclick="switchTab('ticker')" id="ticker-tab">
                    <div class="tab-icon">🔍</div>
                    <div class="tab-label">Ticker</div>
                </button>
                <button class="tab" onclick="switchTab('alpaca')" id="alpaca-tab">
                    <div class="tab-icon">🏦</div>
                    <div class="tab-label">Alpaca</div>
                </button>
                <button class="tab" onclick="switchTab('analysis')" id="analysis-tab">
                    <div class="tab-icon">📊</div>
                    <div class="tab-label">Analysis</div>
                </button>
                <button class="tab" onclick="switchTab('market')" id="market-tab">
                    <div class="tab-icon">🌍</div>
                    <div class="tab-label">Market</div>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentTab = 'chat';
        let messages = [
            {
                id: 1,
                type: 'assistant',
                text: "🤖 **Rolo AI Trading Assistant with Alpaca Integration**\n\nI'm your professional trading AI powered by Claude with LIVE market intelligence, Discord sentiment analysis, AND your Alpaca brokerage account. I provide:\n\n✅ **Real Alpaca account data** - portfolio, buying power, positions\n✅ **Live market analysis** with VIX, sector data & sentiment\n✅ **Discord social sentiment** from trading communities\n✅ **Personalized options strategies** based on YOUR account\n✅ **Risk management** tailored to your buying power\n\n**Ask me:**\n• \"Show my Alpaca portfolio and suggest trades\"\n• \"AAPL options strategy with my current buying power\"\n• \"What positions should I close based on Discord sentiment?\"\n• \"Best trades for my account size with current VIX\"\n\n**Ready to analyze your real account with live market + social data!** 🚀"
            }
        ];
        let isTyping = false;
        let alpacaData = null;
        let alpacaConnected = false;
        let marketData = {};
        let discordSentiment = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            renderCurrentTab();
            loadAlpacaData();
            loadMarketData();
            loadDiscordSentiment();
        });

        // ALPACA INTEGRATION
        async function loadAlpacaData() {
            try {
                const response = await fetch('/.netlify/functions/alpaca-data');
                const data = await response.json();
                
                if (data.error) {
                    console.log('Alpaca error:', data.error);
                    updateAlpacaStatus('❌ Alpaca: ' + data.error, false);
                    alpacaData = { error: data.error };
                } else {
                    alpacaData = data;
                    alpacaConnected = true;
                    updateAlpacaStatus('🟢 Alpaca: Connected (Paper Trading)', true);
                }
                
                if (currentTab === 'alpaca') {
                    renderCurrentTab();
                }
                
            } catch (error) {
                console.error('Alpaca connection error:', error);
                updateAlpacaStatus('❌ Alpaca: Connection Failed', false);
                alpacaData = { error: error.message };
            }
        }

        function updateAlpacaStatus(message, connected) {
            const statusBar = document.getElementById('alpacaStatus');
            if (statusBar) {
                const dotColor = connected ? '#22c55e' : '#ef4444';
                statusBar.innerHTML = `
                    <div class="status-dot" style="background: ${dotColor};"></div>
                    <span>${message}</span>
                `;
                statusBar.style.background = connected ? '#dcfce7' : '#fee2e2';
                statusBar.style.color = connected ? '#166534' : '#dc2626';
            }
        }

        // ENHANCED MESSAGING WITH ALPACA CONTEXT
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            messages.push({
                id: messages.length + 1,
                type: 'user',
                text: message
            });
            
            input.value = '';
            isTyping = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '⏳';
            renderCurrentTab();
            
            try {
                const enhancedMessage = await enhanceMessageWithFullContext(message);
                
                const response = await fetch('/.netlify/functions/claude-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: enhancedMessage })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                messages.push({
                    id: messages.length + 1,
                    type: 'assistant',
                    text: data.response || 'No response received from Claude API'
                });
                
            } catch (error) {
                console.error('Claude API Error:', error);
                
                messages.push({
                    id: messages.length + 1,
                    type: 'assistant',
                    text: `❌ **Claude AI Connection Failed**\n\n**Error**: ${error.message}\n\n**To fix this:**\n1. Ensure ANTHROPIC_API_KEY is set in Netlify environment variables\n2. Verify your API key is valid and has credits\n3. Check network connection\n\n**Alpaca, Discord sentiment and market data still available in other tabs.**`
                });
            }
            
            isTyping = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '➤';
            renderCurrentTab();
            
            setTimeout(() => {
                const messagesDiv = document.querySelector('.messages');
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 100);
        }

        // Enhanced context with Alpaca data
        async function enhanceMessageWithFullContext(message) {
            try {
                if (!marketData.vix) await loadMarketData();
                if (!discordSentiment.volume) await loadDiscordSentiment();
                if (!alpacaData && !alpacaData?.error) await loadAlpacaData();
                
                let alpacaContext = '';
                if (alpacaConnected && alpacaData.account) {
                    alpacaContext = `\n\nYOUR ALPACA ACCOUNT:
- Buying Power: $${parseFloat(alpacaData.account.buying_power).toFixed(2)}
- Portfolio Value: $${parseFloat(alpacaData.account.portfolio_value).toFixed(2)}
- Cash: $${parseFloat(alpacaData.account.cash).toFixed(2)}
- Day Trade Buying Power: $${parseFloat(alpacaData.account.daytrading_buying_power).toFixed(2)}
- Account Type: ${alpacaData.account.pattern_day_trader ? 'Pattern Day Trader' : 'Standard'}`;
                } else if (alpacaData?.error) {
                    alpacaContext = `\n\nALPACA STATUS: ${alpacaData.error}`;
                }
                
                const tickers = extractTickersFromMessage(message);
                let tickerContext = '';
                
                if (tickers.length > 0) {
                    const ticker = tickers[0];
                    const discordData = discordSentiment.tickers?.[ticker];
                    
                    if (discordData) {
                        tickerContext = `\n\nDISCORD SENTIMENT FOR ${ticker}:
- Overall: ${discordData.sentiment} (${discordData.bullishPercent}% bullish, ${discordData.bearishPercent}% bearish)
- Volume: ${discordData.volume} mentions in last 24h`;
                    }
                }
                
                const fullContext = `
CURRENT MARKET CONDITIONS:
- VIX: ${marketData.vix?.price || 'N/A'} (${getVIXSentiment(marketData.vix?.price)})
- S&P 500: ${marketData.sp500?.price || 'N/A'} (${marketData.sp500?.change || 'N/A'}%)
- Market Sentiment: ${getMarketSentiment()}

DISCORD TRADING SENTIMENT:
- Overall Discord Sentiment: ${discordSentiment.overall || 'N/A'}
- Total Volume: ${discordSentiment.volume || 0} messages analyzed
- Trending Tickers: ${Object.keys(discordSentiment.tickers || {}).slice(0, 3).join(', ') || 'N/A'}${tickerContext}${alpacaContext}

Original Question: ${message}

Provide specific options strategies considering market conditions, social sentiment, AND the user's actual Alpaca account data. Tailor position sizes to their buying power and account type. If account data is unavailable, mention this limitation.`;
                
                return fullContext;
            } catch (error) {
                return message;
            }
        }

        // MARKET DATA AND SENTIMENT (same as before)
        async function loadMarketData() {
            try {
                const symbols = ['^GSPC', '^IXIC', '^DJI', '^VIX'];
                const promises = symbols.map(symbol => fetchYahooData(symbol));
                const results = await Promise.all(promises);
                
                marketData = {
                    sp500: results[0],
                    nasdaq: results[1], 
                    dow: results[2],
                    vix: results[3],
                    timestamp: new Date()
                };
                
                return marketData;
            } catch (error) {
                console.error('Market data error:', error);
                return null;
            }
        }

        async function fetchYahooData(symbol) {
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                
                const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const quote = result.indicators.quote[0];
                    const meta = result.meta;
                    
                    const currentPrice = meta.regularMarketPrice || quote.close[quote.close.length - 1];
                    const previousClose = meta.previousClose;
                    const change = currentPrice - previousClose;
                    const changePercent = (change / previousClose) * 100;
                    
                    return {
                        symbol: symbol,
                        price: currentPrice?.toFixed(2),
                        change: change?.toFixed(2),
                        changePercent: changePercent?.toFixed(2),
                        volume: meta.regularMarketVolume || 0,
                        timestamp: new Date()
                    };
                }
                
                return generateMockMarketData(symbol);
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return generateMockMarketData(symbol);
            }
        }

        function generateMockMarketData(symbol) {
            const baseValues = {
                '^GSPC': 4400, '^IXIC': 13800, '^DJI': 34000, '^VIX': 18
            };
            
            const base = baseValues[symbol] || 100;
            const change = (Math.random() - 0.5) * base * 0.02;
            const price = base + change;
            const changePercent = (change / base) * 100;
            
            return {
                symbol: symbol,
                price: price.toFixed(2),
                change: change.toFixed(2),
                changePercent: changePercent.toFixed(2),
                volume: Math.floor(Math.random() * 1000000),
                timestamp: new Date()
            };
        }

        async function loadDiscordSentiment() {
            try {
                const response = await fetch('/.netlify/functions/discord-sentiment');
                const data = await response.json();
                
                if (data.error) {
                    discordSentiment = generateMockDiscordSentiment();
                } else {
                    discordSentiment = data;
                }
                
                return discordSentiment;
            } catch (error) {
                console.error('Discord sentiment error:', error);
                discordSentiment = generateMockDiscordSentiment();
                return discordSentiment;
            }
        }

        function generateMockDiscordSentiment() {
            const mockTickers = ['SPY', 'QQQ', 'AAPL', 'TSLA', 'NVDA', 'MSFT'];
            const sentiment = {
                overall: ['bullish', 'bearish', 'neutral'][Math.floor(Math.random() * 3)],
                bullish: Math.floor(Math.random() * 50) + 20,
                bearish: Math.floor(Math.random() * 30) + 10,
                neutral: Math.floor(Math.random() * 40) + 15,
                volume: Math.floor(Math.random() * 200) + 100,
                tickers: {},
                timestamp: new Date().toISOString()
            };
            
            for (const ticker of mockTickers) {
                const bullish = Math.floor(Math.random() * 20) + 5;
                const bearish = Math.floor(Math.random() * 15) + 3;
                const neutral = Math.floor(Math.random() * 10) + 2;
                const total = bullish + bearish + neutral;
                
                sentiment.tickers[ticker] = {
                    bullish,
                    bearish,
                    neutral,
                    volume: total,
                    sentiment: bullish > bearish * 1.2 ? 'bullish' : bearish > bullish * 1.2 ? 'bearish' : 'neutral',
                    bullishPercent: Math.round((bullish / total) * 100),
                    bearishPercent: Math.round((bearish / total) * 100)
                };
            }
            
            return sentiment;
        }

        function extractTickersFromMessage(message) {
            const tickerRegex = /\b([A-Z]{1,5})\b/g;
            const tickers = [];
            let match;
            
            while ((match = tickerRegex.exec(message.toUpperCase())) !== null) {
                const ticker = match[1];
                if (ticker.length >= 1 && ticker.length <= 5) {
                    tickers.push(ticker);
                }
            }
            
            return [...new Set(tickers)];
        }

        function getVIXSentiment(vix) {
            if (!vix) return 'Unknown';
            const vixValue = parseFloat(vix);
            if (vixValue < 15) return 'Extreme Greed';
            if (vixValue < 20) return 'Greed';
            if (vixValue < 25) return 'Neutral';
            if (vixValue < 30) return 'Fear';
            return 'Extreme Fear';
        }

        function getMarketSentiment() {
            if (!marketData.sp500 || !marketData.vix) return 'Unknown';
            
            const spChange = parseFloat(marketData.sp500.changePercent);
            const vixLevel = parseFloat(marketData.vix.price);
            
            if (spChange > 1 && vixLevel < 20) return 'Strong Bull Market';
            if (spChange > 0 && vixLevel < 25) return 'Bullish';
            if (spChange < -1 || vixLevel > 30) return 'Bearish';
            return 'Neutral';
        }

        // Tab switching
        function switchTab(tab) {
            if (currentTab === tab) return;
            
            const content = document.getElementById('content');
            const inputSection = document.getElementById('inputSection');
            
            if (tab === 'chat') {
                inputSection.style.display = 'block';
                content.style.paddingBottom = '8rem';
            } else {
                inputSection.style.display = 'none';
                content.style.paddingBottom = '5rem';
            }
            
            content.classList.add('fade-out');
            
            setTimeout(() => {
                currentTab = tab;
                
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                const activeTab = document.getElementById(tab + '-tab');
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                renderCurrentTab();
                content.classList.remove('fade-out');
                
                if (tab === 'chat') {
                    setTimeout(() => {
                        const messageInput = document.getElementById('messageInput');
                        if (messageInput) {
                            messageInput.focus();
                        }
                    }, 350);
                }
                
                if (tab === 'alpaca') {
                    loadAlpacaData();
                }
            }, 150);
        }

        function goHome() {
            switchTab('chat');
        }

        function renderCurrentTab() {
            const content = document.getElementById('content');
            let tabContent = '';
            
            switch(currentTab) {
                case 'chat':
                    tabContent = renderChat();
                    break;
                case 'ticker':
                    tabContent = renderTicker();
                    break;
                case 'alpaca':
                    tabContent = renderAlpaca();
                    break;
                case 'analysis':
                    tabContent = renderAnalysis();
                    break;
                case 'market':
                    tabContent = renderMarket();
                    break;
            }
            
            content.innerHTML = `<div class="page-content">${tabContent}</div>`;
            
            if (currentTab === 'chat') {
                setTimeout(() => {
                    const messagesDiv = document.querySelector('.messages');
                    if (messagesDiv) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }, 100);
            }
        }

        // Render functions
        function renderChat() {
            return `
                <div class="scrollable-content">
                    <div class="card">
                        <div class="alpaca-card">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.25rem;">🤖</span>
                                <strong>Real Claude AI + Alpaca Brokerage</strong>
                            </div>
                            <div style="font-size: 0.8rem;">
                                Professional options analysis • Live account data • Market + social sentiment
                            </div>
                        </div>
                        
                        <div class="messages">
                            ${messages.map(msg => `
                                <div class="message ${msg.type}">
                                    <div class="message-content">${msg.text}</div>
                                    ${msg.type === 'assistant' ? '<div class="message-meta">🤖 Claude AI • Account + Market + Social Analysis</div>' : ''}
                                </div>
                            `).join('')}
                            ${isTyping ? '<div class="message assistant"><div class="message-content">🤖 Claude is analyzing with your account + market + Discord data...</div></div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTicker() {
            return `
                <div class="card">
                    <button class="home-btn" onclick="goHome()">
                        <span>🏠</span>
                        <span>Back to Chat</span>
                    </button>
                    
                    <h3>🔍 Stock Analysis</h3>
                    <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">
                        Quick ticker lookup and analysis
                    </p>
                    
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                        <h4>Use Chat for Stock Analysis</h4>
                        <p style="color: #6b7280; margin-bottom: 1.5rem;">Ask Claude for detailed analysis with your account context</p>
                        <button class="btn" onclick="goHome()">💬 Go to Chat</button>
                    </div>
                </div>
            `;
        }

        function renderAlpaca() {
            if (alpacaData?.error) {
                return `
                    <div class="card">
                        <button class="home-btn" onclick="goHome()">
                            <span>🏠</span>
                            <span>Back to Chat</span>
                        </button>
                        
                        <h3>🏦 Alpaca Account</h3>
                        
                        <div class="error-card">
                            <h4>❌ Alpaca Connection Failed</h4>
                            <p style="margin: 0.5rem 0;"><strong>Error:</strong> ${alpacaData.error}</p>
                            
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fca5a5;">
                                <h5>🛠️ Setup Instructions for Beginners:</h5>
                                <ol style="margin: 0.5rem 0; padding-left: 1.5rem; line-height: 1.6;">
                                    <li><strong>Get Alpaca API Keys:</strong><br>
                                        • Go to <a href="https://app.alpaca.markets" target="_blank" style="color: #2563eb;">app.alpaca.markets</a><br>
                                        • Login to your account<br>
                                        • Go to "API Keys" in the menu<br>
                                        • Create new Paper Trading keys<br>
                                        • Copy the Key ID and Secret Key
                                    </li>
                                    <li><strong>Add to Netlify:</strong><br>
                                        • Go to your Netlify dashboard<br>
                                        • Site Settings → Environment Variables<br>
                                        • Add: ALPACA_API_KEY = (your key)<br>
                                        • Add: ALPACA_SECRET_KEY = (your secret)<br>
                                        • Add: ALPACA_BASE_URL = https://paper-api.alpaca.markets
                                    </li>
                                    <li><strong>Redeploy:</strong><br>
                                        • Trigger a new deployment in Netlify<br>
                                        • Wait for it to complete<br>
                                        • Refresh this page
                                    </li>
                                </ol>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="loadAlpacaData()" style="background: #059669;">
                            🔄 Retry Connection
                        </button>
                    </div>
                `;
            }
            
            if (!alpacaConnected || !alpacaData?.account) {
                return `
                    <div class="card">
                        <button class="home-btn" onclick="goHome()">
                            <span>🏠</span>
                            <span>Back to Chat</span>
                        </button>
                        
                        <h3>🏦 Alpaca Account</h3>
                        
                        <div style="text-align: center; padding: 3rem 1rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
                            <h4>Connecting to Alpaca...</h4>
                            <p style="color: #6b7280;">Loading your account data</p>
                        </div>
                    </div>
                `;
            }
            
            const account = alpacaData.account;
            const buyingPower = parseFloat(account.buying_power);
            const portfolioValue = parseFloat(account.portfolio_value);
            const cash = parseFloat(account.cash);
            const dayTradeBuyingPower = parseFloat(account.daytrading_buying_power);
            
            return `
                <div class="card">
                    <button class="home-btn" onclick="goHome()">
                        <span>🏠</span>
                        <span>Back to Chat</span>
                    </button>
                    
                    <h3>🏦 Your Alpaca Account</h3>
                    
                    <div class="success-card">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">🟢</span>
                            <strong>Connected to Paper Trading Account</strong>
                        </div>
                        <div style="font-size: 0.9rem;">
                            Real-time account data • Risk-free practice environment
                        </div>
                    </div>
                    
                    <div class="account-info">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-weight: 700; color: #0ea5e9;">
                            <span>💰</span>
                            <span>Account Overview</span>
                        </div>
                        
                        <div class="account-grid">
                            <div class="account-stat">
                                <div class="stat-label">Portfolio Value</div>
                                <div class="stat-value-large">$${portfolioValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="account-stat">
                                <div class="stat-label">Buying Power</div>
                                <div class="stat-value-large">$${buyingPower.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="account-stat">
                                <div class="stat-label">Cash</div>
                                <div class="stat-value-large">$${cash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="account-stat">
                                <div class="stat-label">Day Trade Power</div>
                                <div class="stat-value-large">$${dayTradeBuyingPower.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem; color: #6b7280;">Account Status:</span>
                                <span style="font-weight: 600; color: ${account.pattern_day_trader ? '#dc2626' : '#059669'};">
                                    ${account.pattern_day_trader ? 'Pattern Day Trader' : 'Standard Account'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span style="font-size: 0.9rem; color: #6b7280;">Account Type:</span>
                                <span style="font-weight: 600; color: #7c3aed;">Paper Trading</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem;">
                        <h4 style="margin-bottom: 1rem;">🤖 Get Personalized Trading Advice</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <button class="btn" onclick="askClaudeWithAccount('Analyze my account and suggest 3 options strategies based on my buying power and current market conditions')">
                                📊 Account-Based Strategies
                            </button>
                            <button class="btn" onclick="askClaudeWithAccount('What size positions should I take with my current buying power? Include risk management.')" style="background: #059669;">
                                💰 Position Sizing Guide
                            </button>
                            <button class="btn" onclick="askClaudeWithAccount('Show me conservative options plays suitable for my account size with Discord sentiment')" style="background: #dc2626;">
                                🛡️ Conservative Plays
                            </button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">
                            <div style="font-size: 0.8rem; color: #6b7280;">
                                Last Updated: ${new Date().toLocaleTimeString()}
                            </div>
                            <button class="btn btn-small" onclick="loadAlpacaData()" style="margin-top: 0.5rem;">
                                🔄 Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAnalysis() {
            return `
                <div class="card">
                    <button class="home-btn" onclick="goHome()">
                        <span>🏠</span>
                        <span>Back to Chat</span>
                    </button>
                    
                    <h3>📊 AI Analysis</h3>
                    
                    <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🤖</div>
                        <h4 style="margin-bottom: 0.5rem;">Advanced Analysis Available</h4>
                        <p style="margin-bottom: 1.5rem;">Get personalized analysis based on your Alpaca account, market conditions, and social sentiment.</p>
                        <button class="btn" onclick="goHome()">💬 Chat with Claude AI</button>
                    </div>
                </div>
            `;
        }

        function renderMarket() {
            return `
                <div class="card">
                    <button class="home-btn" onclick="goHome()">
                        <span>🏠</span>
                        <span>Back to Chat</span>
                    </button>
                    
                    <h3>🌍 Market Overview</h3>
                    
                    <div style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📈</div>
                        <h4 style="margin-bottom: 0.5rem;">Market Data Integration</h4>
                        <p style="margin-bottom: 1.5rem;">Real-time market data is integrated into chat analysis and account-based strategies.</p>
                        <button class="btn" onclick="goHome()">💬 Get Market Analysis</button>
                    </div>
                </div>
            `;
        }

        // Helper functions
        function askClaudeWithAccount(question) {
            switchTab('chat');
            setTimeout(() => {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.value = question;
                    sendMessage();
                }
            }, 300);
        }
    </script>
</body>
</html>
