<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Configuration for Address Bar Hiding -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rolo AI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23007aff'/><text x='90' y='110' font-family='Arial' font-size='60' font-weight='bold' text-anchor='middle' fill='white'>R</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23007aff'/><text x='16' y='22' font-family='Arial' font-size='16' font-weight='bold' text-anchor='middle' fill='white'>R</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        'name': 'Rolo AI Trading Assistant',
        'short_name': 'Rolo AI',
        'description': 'Smart AI-powered trading assistant with real-time market data',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#000000',
        'theme_color': '#007aff',
        'orientation': 'portrait',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 192 192\"><rect width=\"192\" height=\"192\" fill=\"%23007aff\"/><text x=\"96\" y=\"120\" font-family=\"Arial\" font-size=\"80\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"white\">R</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            },
            {
                'src': 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><rect width=\"512\" height=\"512\" fill=\"%23007aff\"/><text x=\"256\" y=\"320\" font-family=\"Arial\" font-size=\"200\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"white\">R</text></svg>',
                'sizes': '512x512',
                'type': 'image/svg+xml'
            }
        ]
    }">
    
    <title>Rolo AI - Smart Trading Assistant</title>
    
    <style>
        /* iPhone-First PWA Design with Address Bar Hiding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            overscroll-behavior: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: #fff;
            touch-action: manipulation;
            /* iOS specific adjustments */
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* App Container - Full Screen PWA */
        .app {
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            position: relative;
            overflow: hidden;
        }
        
        /* Header with full screen support */
        .header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: env(safe-area-inset-top, 20px) 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #5b73ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Real-time status indicators */
        .status-bar {
            position: absolute;
            top: env(safe-area-inset-top, 25px);
            right: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.live { background: #00ff88; }
        .status-dot.delayed { background: #ffaa00; }
        .status-dot.offline { background: #ff4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        /* Main Content with smart scrolling */
        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .tab-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }
        
        .tab-pane.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Chat Tab - Enhanced */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 16px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message.ai .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-bottom-left-radius: 6px;
        }
        
        /* Enhanced analysis display in chat */
        .analysis-section {
            margin: 12px 0;
            padding: 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 12px;
            border-left: 3px solid #007aff;
        }
        
        .analysis-title {
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 8px 0;
        }
        
        .metric-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2px;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Chat Input - Always Visible */
        .chat-input-container {
            position: sticky;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 16px;
            padding: 8px 0;
            font-family: inherit;
        }
        
        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #007aff, #5856d6);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 16px;
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        /* Enhanced Ticker Tab */
        .ticker-container {
            padding: 20px 16px;
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }
        
        .ticker-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            font-size: 18px;
            color: #fff;
            text-transform: uppercase;
            font-weight: 600;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .ticker-input:focus {
            border-color: #007aff;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .search-btn {
            width: 100%;
            background: linear-gradient(135deg, #007aff, #5856d6);
            border: none;
            border-radius: 16px;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        /* Enhanced Stock Display Card */
        .stock-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 24px;
            margin-top: 20px;
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .stock-symbol {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }
        
        .stock-price {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
            text-align: right;
        }
        
        .stock-change {
            font-size: 16px;
            font-weight: 600;
            text-align: right;
            margin-top: 4px;
        }
        
        .stock-change.positive { color: #00ff88; }
        .stock-change.negative { color: #ff6b6b; }
        
        /* Technical Indicators Section */
        .technical-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .technical-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #00d4ff;
        }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .indicator-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        
        .indicator-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }
        
        .indicator-value {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .indicator-signal {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .indicator-signal.bullish { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .indicator-signal.bearish { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .indicator-signal.neutral { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); }
        
        /* Smart Alerts Tab */
        .alerts-container {
            padding: 20px 16px;
        }
        
        .alert-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        
        .alert-priority {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .alert-priority.high { background: #ff4444; }
        .alert-priority.medium { background: #ffaa00; }
        .alert-priority.low { background: #00ff88; }
        
        .alert-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .alert-message {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }
        
        .alert-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Smart Plays Tab */
        .plays-container {
            padding: 20px 16px;
        }
        
        .play-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .play-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .play-symbol {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }
        
        .play-confidence {
            background: rgba(0, 122, 255, 0.2);
            color: #007aff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .play-strategy {
            font-size: 16px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        
        .play-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 12px;
        }
        
        .play-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .play-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }
        
        .reasoning-list {
            margin-top: 12px;
        }
        
        .reasoning-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
            padding-left: 12px;
            position: relative;
        }
        
        .reasoning-item::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #007aff;
        }
        
        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error States */
        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
            padding: 16px;
            border-radius: 12px;
            margin: 16px;
            text-align: center;
            font-size: 14px;
        }
        
        /* Bottom Navigation - PWA Safe */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 0 env(safe-area-inset-bottom, 12px);
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
            min-width: 50px;
        }
        
        .nav-item.active {
            background: rgba(0, 122, 255, 0.2);
            transform: scale(1.05);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }
        
        .nav-item.active .nav-icon {
            color: #007aff;
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .nav-item.active .nav-label {
            color: #007aff;
        }
        
        /* Popular Tickers Grid */
        .popular-tickers {
            margin-top: 30px;
        }
        
        .popular-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }
        
        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .ticker-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .ticker-button:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* News Integration */
        .news-section {
            margin-top: 20px;
        }
        
        .news-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #00d4ff;
        }
        
        .news-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .news-headline {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #fff;
        }
        
        .news-source {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Responsive - Smaller iPhones */
        @media (max-width: 375px) {
            .header h1 { font-size: 20px; }
            .stock-symbol, .stock-price { font-size: 24px; }
            .chat-input-container { padding: 12px; }
            .ticker-container { padding: 16px 12px; }
            .ticker-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Hide scrollbars but keep functionality */
        .messages::-webkit-scrollbar,
        .tab-pane::-webkit-scrollbar {
            display: none;
        }
        
        .messages,
        .tab-pane {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header with Real-time Status -->
        <div class="header">
            <div class="status-bar">
                <div class="status-dot live" id="dataStatus" title="Real-time data"></div>
            </div>
            <h1>Rolo AI</h1>
            <p>Intelligent Trading Assistant</p>
        </div>

        <!-- Main Content -->
        <div class="content">
            
            <!-- Chat Tab (HOME) -->
            <div class="tab-pane active" id="chat">
                <div class="chat-container">
                    <div class="messages" id="messages">
                        <div class="message ai">
                            <div class="message-bubble">
                                üß† <strong>Rolo AI Enhanced</strong> - I'm your intelligent trading assistant with real-time market data, technical analysis, and smart plays generation.
                                <br><br>
                                Try: <strong>"Analyze AAPL with full technicals"</strong> or <strong>"Show me high-confidence plays"</strong>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Ask about any stock, strategy, or market analysis..."
                                autocomplete="off"
                                autocorrect="off"
                                autocapitalize="off"
                                spellcheck="false"
                            >
                            <button class="send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Ticker Tab -->
            <div class="tab-pane" id="ticker">
                <div class="ticker-container">
                    <div class="search-section">
                        <div class="search-title">üîç Comprehensive Stock Analysis</div>
                        <input 
                            type="text" 
                            class="ticker-input" 
                            id="tickerInput" 
                            placeholder="Enter any ticker (AAPL, HOOD, SPY...)"
                            maxlength="10"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="characters"
                            spellcheck="false"
                        >
                        <button class="search-btn" onclick="searchStock()">
                            üìä Analyze Stock
                        </button>
                    </div>
                    
                    <div class="popular-tickers">
                        <div class="popular-title">üìà Popular Stocks</div>
                        <div class="ticker-grid">
                            <button class="ticker-button" onclick="quickSearch('AAPL')">AAPL</button>
                            <button class="ticker-button" onclick="quickSearch('TSLA')">TSLA</button>
                            <button class="ticker-button" onclick="quickSearch('HOOD')">HOOD</button>
                            <button class="ticker-button" onclick="quickSearch('SPY')">SPY</button>
                            <button class="ticker-button" onclick="quickSearch('NVDA')">NVDA</button>
                            <button class="ticker-button" onclick="quickSearch('QQQ')">QQQ</button>
                            <button class="ticker-button" onclick="quickSearch('AMD')">AMD</button>
                            <button class="ticker-button" onclick="quickSearch('META')">META</button>
                            <button class="ticker-button" onclick="quickSearch('GOOGL')">GOOGL</button>
                        </div>
                    </div>
                    
                    <div id="stockResults"></div>
                </div>
            </div>

            <!-- Enhanced Analysis Tab -->
            <div class="tab-pane" id="analysis">
                <div class="ticker-container">
                    <div class="analysis-card" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 24px; margin-bottom: 20px;">
                        <div class="search-title">üìä Advanced Technical Analysis</div>
                        <div id="analysisContent" style="color: rgba(255, 255, 255, 0.9); line-height: 1.6;">
                            Search for a stock to see comprehensive technical analysis including RSI, MACD, Bollinger Bands, moving averages, and smart signals.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Plays Tab -->
            <div class="tab-pane" id="plays">
                <div class="plays-container">
                    <div class="search-section">
                        <div class="search-title">üéØ AI-Generated Smart Plays</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <button class="ticker-button" onclick="loadSmartPlays('all')" style="flex: 1;">All Plays</button>
                            <button class="ticker-button" onclick="loadSmartPlays('options')" style="flex: 1;">Options</button>
                            <button class="ticker-button" onclick="loadSmartPlays('momentum')" style="flex: 1;">Momentum</button>
                        </div>
                    </div>
                    <div id="playsContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading intelligent trading opportunities...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Tab -->
            <div class="tab-pane" id="market">
                <div class="ticker-container">
                    <div class="analysis-card" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 24px; margin-bottom: 20px;">
                        <div class="search-title">üìà Live Market Overview</div>
                        <div class="indicators-grid" style="margin-top: 16px;">
                            <div class="indicator-card">
                                <div class="indicator-label">SPY</div>
                                <div class="indicator-value" id="spyPrice">Loading...</div>
                                <div class="indicator-signal neutral" id="spySignal">---</div>
                            </div>
                            <div class="indicator-card">
                                <div class="indicator-label">QQQ</div>
                                <div class="indicator-value" id="qqqPrice">Loading...</div>
                                <div class="indicator-signal neutral" id="qqqSignal">---</div>
                            </div>
                            <div class="indicator-card">
                                <div class="indicator-label">VIX</div>
                                <div class="indicator-value" id="vixPrice">Loading...</div>
                                <div class="indicator-signal neutral" id="vixSignal">---</div>
                            </div>
                            <div class="indicator-card">
                                <div class="indicator-label">Market Sentiment</div>
                                <div class="indicator-value" id="sentiment">Analyzing...</div>
                                <div class="indicator-signal neutral" id="sentimentSignal">---</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Alerts Tab -->
            <div class="tab-pane" id="alerts">
                <div class="alerts-container">
                    <div class="search-section">
                        <div class="search-title">üîî Intelligent Market Alerts</div>
                        <button class="search-btn" onclick="refreshAlerts()" style="margin-bottom: 20px;">
                            üîÑ Refresh Alerts
                        </button>
                    </div>
                    <div id="alertsContent">
                        <div class="loading">
                            <div class="spinner"></div>
                            Scanning market for opportunities...
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-container">
                <div class="nav-item active" onclick="switchTab('chat')">
                    <div class="nav-icon">üí¨</div>
                    <div class="nav-label">Chat</div>
                </div>
                <div class="nav-item" onclick="switchTab('ticker')">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">Ticker</div>
                </div>
                <div class="nav-item" onclick="switchTab('analysis')">
                    <div class="nav-icon">üìà</div>
                    <div class="nav-label">Analysis</div>
                </div>
                <div class="nav-item" onclick="switchTab('plays')">
                    <div class="nav-icon">üéØ</div>
                    <div class="nav-label">Plays</div>
                </div>
                <div class="nav-item" onclick="switchTab('market')">
                    <div class="nav-icon">üåç</div>
                    <div class="nav-label">Market</div>
                </div>
                <div class="nav-item" onclick="switchTab('alerts')">
                    <div class="nav-icon">üîî</div>
                    <div class="nav-label">Alerts</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'chat';
        let stockCache = {};
        let isDataLive = false;
        
        // Initialize PWA app
        document.addEventListener('DOMContentLoaded', function() {
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript,console.log("SW loaded")');
            }
            
            // Chat is home/default
            switchTab('chat');
            loadMarketData();
            loadSmartPlays('all');
            loadSmartAlerts();
            
            // Auto-focus chat input
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
            }, 500);
            
            // Update data status every 30 seconds
            setInterval(updateDataStatus, 30000);
            
            // Prevent iOS zoom and handle PWA-specific behaviors
            document.addEventListener('touchstart', function() {}, {passive: true});
            document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const label = item.querySelector('.nav-label').textContent.toLowerCase();
                if (label === tabName) {
                    item.classList.add('active');
                }
            });
            
            currentTab = tabName;
            
            // Load tab-specific data
            if (tabName === 'plays' && !document.getElementById('playsContent').innerHTML.includes('play-item')) {
                loadSmartPlays('all');
            } else if (tabName === 'alerts' && !document.getElementById('alertsContent').innerHTML.includes('alert-item')) {
                loadSmartAlerts();
            }
            
            // Focus inputs
            setTimeout(() => {
                if (tabName === 'chat') {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) chatInput.focus();
                } else if (tabName === 'ticker') {
                    const tickerInput = document.getElementById('tickerInput');
                    if (tickerInput) tickerInput.focus();
                }
            }, 300);
        }

        // Enhanced chat with comprehensive analysis
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            const typingId = addMessage('üß† Analyzing with real-time data...', 'ai', true);
            
            try {
                const response = await getComprehensiveAIResponse(message);
                removeMessage(typingId);
                addMessage(response, 'ai');
            } catch (error) {
                console.error('Chat error:', error);
                removeMessage(typingId);
                addMessage('I\'m having trouble accessing real-time data. Please try again.', 'ai');
            }
        }

        // Comprehensive AI response with real data
        async function getComprehensiveAIResponse(message) {
            const ticker = extractTicker(message);
            
            if (ticker) {
                // Get comprehensive stock data
                const comprehensiveData = await getComprehensiveStockData(ticker);
                
                if (comprehensiveData && comprehensiveData.price) {
                    return generateComprehensiveAnalysis(ticker, comprehensiveData, message);
                } else {
                    return `I couldn't find comprehensive data for ${ticker.toUpperCase()}. Please verify the ticker symbol.`;
                }
            } else {
                return getAdvancedTradingAdvice(message);
            }
        }

        // Get comprehensive stock data using new functions
        async function getComprehensiveStockData(symbol) {
            try {
                // Check cache first (30 second cache)
                if (stockCache[symbol] && Date.now() - stockCache[symbol].timestamp < 30000) {
                    return stockCache[symbol].data;
                }
                
                const response = await fetch(`/.netlify/functions/stock-data?symbol=${symbol}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Cache the comprehensive data
                stockCache[symbol] = {
                    data: data,
                    timestamp: Date.now()
                };
                
                return data;
            } catch (error) {
                console.error('Comprehensive stock data error:', error);
                return null;
            }
        }

        // Generate comprehensive analysis
        function generateComprehensiveAnalysis(ticker, data, message) {
            if (!data.price) return `No price data available for ${ticker}`;
            
            const { price, technical, smartSignals, news, sentiment } = data;
            
            let analysis = `üìä **${ticker} Comprehensive Analysis**\n\n`;
            
            // Price section with real-time status
            analysis += `üí∞ **Real-time Price**: $${price.price.toFixed(2)}\n`;
            analysis += `üìà **Change**: ${price.change >= 0 ? '+' : ''}$${price.change.toFixed(2)} (${price.changePercent >= 0 ? '+' : ''}${price.changePercent.toFixed(2)}%)\n`;
            analysis += `üìä **Range**: $${price.low.toFixed(2)} - $${price.high.toFixed(2)}\n`;
            analysis += `üì¶ **Volume**: ${(price.volume / 1000000).toFixed(1)}M shares\n\n`;
            
            // Technical analysis section
            if (technical) {
                analysis += `üî¨ **Technical Indicators**:\n`;
                
                if (technical.rsi) {
                    const rsiSignal = technical.rsi.value > 70 ? 'Overbought' : technical.rsi.value < 30 ? 'Oversold' : 'Neutral';
                    analysis += `‚Ä¢ **RSI (14)**: ${technical.rsi.value.toFixed(1)} - ${rsiSignal}\n`;
                }
                
                if (technical.macd) {
                    analysis += `‚Ä¢ **MACD**: ${technical.macd.crossover} crossover (${technical.macd.histogram > 0 ? 'Positive' : 'Negative'} histogram)\n`;
                }
                
                if (technical.sma20 && technical.sma50) {
                    const trendDirection = price.price > technical.sma20.value && technical.sma20.value > technical.sma50.value ? 'Bullish' : 
                                         price.price < technical.sma20.value && technical.sma20.value < technical.sma50.value ? 'Bearish' : 'Mixed';
                    analysis += `‚Ä¢ **Moving Averages**: ${trendDirection} trend (20-day: $${technical.sma20.value.toFixed(2)}, 50-day: $${technical.sma50.value.toFixed(2)})\n`;
                }
                
                if (technical.bollingerBands) {
                    const bbPosition = price.price > technical.bollingerBands.upper ? 'Above upper band' :
                                      price.price < technical.bollingerBands.lower ? 'Below lower band' : 'Within bands';
                    analysis += `‚Ä¢ **Bollinger Bands**: ${bbPosition} ($${technical.bollingerBands.lower.toFixed(2)} - $${technical.bollingerBands.upper.toFixed(2)})\n`;
                }
                
                analysis += '\n';
            }
            
            // Smart signals section
            if (smartSignals && smartSignals.signals && smartSignals.signals.length > 0) {
                analysis += `üß† **Smart Signals** (${smartSignals.overall.toUpperCase()}):\n`;
                smartSignals.signals.slice(0, 3).forEach(signal => {
                    analysis += `‚Ä¢ **${signal.indicator}**: ${signal.message}\n`;
                });
                analysis += '\n';
            }
            
            // Options strategy recommendations
            if (message.toLowerCase().includes('option') || message.toLowerCase().includes('strategy')) {
                analysis += `üéØ **Options Strategy Recommendations**:\n\n`;
                
                if (smartSignals && smartSignals.plays && smartSignals.plays.length > 0) {
                    smartSignals.plays.slice(0, 2).forEach(play => {
                        analysis += `‚Ä¢ **${play.strategy}**: ${play.reason} (Confidence: ${Math.round(play.confidence * 100)}%)\n`;
                    });
                } else {
                    // Generate basic options strategies based on technical analysis
                    if (technical?.rsi) {
                        if (technical.rsi.value > 70) {
                            analysis += `‚Ä¢ **Put Spreads**: RSI overbought suggests potential pullback\n`;
                            analysis += `‚Ä¢ **Covered Calls**: Sell premium in high volatility environment\n`;
                        } else if (technical.rsi.value < 30) {
                            analysis += `‚Ä¢ **Call Spreads**: RSI oversold suggests potential bounce\n`;
                            analysis += `‚Ä¢ **Cash-Secured Puts**: Enter position at discount\n`;
                        } else {
                            analysis += `‚Ä¢ **Iron Condors**: Neutral RSI suggests range-bound trading\n`;
                            analysis += `‚Ä¢ **Straddles**: Position for volatility expansion\n`;
                        }
                    }
                }
                analysis += '\n';
            }
            
            // News and sentiment
            if (news && news.length > 0) {
                analysis += `üì∞ **Recent News**:\n`;
                news.slice(0, 2).forEach(article => {
                    analysis += `‚Ä¢ ${article.title} (${article.source})\n`;
                });
                analysis += '\n';
            }
            
            // Risk management
            analysis += `‚ö†Ô∏è **Risk Management**: Always use proper position sizing and stop losses. Consider the current market volatility and your risk tolerance.`;
            
            return analysis;
        }

        // Advanced trading advice
        function getAdvancedTradingAdvice(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('smart plays') || msg.includes('high confidence')) {
                return `üéØ **High-Confidence Smart Plays Available**\n\nI'm analyzing the market for top opportunities. Check the **Plays** tab for:\n\n‚Ä¢ AI-generated trading strategies\n‚Ä¢ Options plays with confidence scores\n‚Ä¢ Momentum and mean reversion opportunities\n‚Ä¢ Volatility and breakout plays\n\nEach play includes entry/exit points, reasoning, and risk assessment!`;
            }
            
            if (msg.includes('alerts') || msg.includes('notifications')) {
                return `üîî **Smart Alerts System Active**\n\nMonitoring market for:\n\n‚Ä¢ Unusual volume spikes\n‚Ä¢ Technical breakouts\n‚Ä¢ RSI extreme conditions\n‚Ä¢ Bollinger Band breaches\n‚Ä¢ MACD crossovers\n‚Ä¢ Market volatility changes\n\nCheck the **Alerts** tab for real-time notifications!`;
            }
            
            if (msg.includes('market') || msg.includes('overview')) {
                return `üìà **Live Market Analysis Available**\n\nReal-time monitoring of:\n\n‚Ä¢ SPY (S&P 500 direction)\n‚Ä¢ QQQ (Tech sector health)\n‚Ä¢ VIX (Market fear/volatility)\n‚Ä¢ Sector rotation signals\n‚Ä¢ Market sentiment analysis\n\nCheck the **Market** tab for current conditions!`;
            }
            
            return `üß† **Rolo AI Enhanced Features**\n\nI can provide:\n\n‚Ä¢ **Comprehensive stock analysis** with real-time technical indicators\n‚Ä¢ **Smart trading plays** with confidence scores and reasoning\n‚Ä¢ **Real-time alerts** for market opportunities\n‚Ä¢ **Options strategies** based on current market conditions\n‚Ä¢ **Risk management** guidance\n\nTry: "Analyze AAPL with full technicals" or mention any ticker for detailed analysis!`;
        }

        // Enhanced stock search with comprehensive data
        async function searchStock() {
            const input = document.getElementById('tickerInput');
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) {
                showStockError('Please enter a ticker symbol');
                return;
            }
            
            await performComprehensiveStockSearch(ticker);
        }

        async function quickSearch(ticker) {
            document.getElementById('tickerInput').value = ticker;
            await performComprehensiveStockSearch(ticker);
        }

        async function performComprehensiveStockSearch(ticker) {
            const resultsContainer = document.getElementById('stockResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading comprehensive analysis...</div>';
            
            try {
                const data = await getComprehensiveStockData(ticker);
                
                if (data && data.price) {
                    displayComprehensiveStockCard(data);
                    updateAnalysisTab(ticker, data);
                } else {
                    showStockError(`Could not find comprehensive data for ${ticker}`);
                }
            } catch (error) {
                console.error('Stock search error:', error);
                showStockError('Error loading comprehensive stock data');
            }
        }

        // Display comprehensive stock card
        function displayComprehensiveStockCard(data) {
            const resultsContainer = document.getElementById('stockResults');
            const price = data.price;
            const technical = data.technical;
            const smartSignals = data.smartSignals;
            
            const change = parseFloat(price.change);
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeSymbol = change >= 0 ? '+' : '';
            
            let cardHTML = `
                <div class="stock-card">
                    <div class="stock-header">
                        <div class="stock-symbol">${price.symbol}</div>
                        <div>
                            <div class="stock-price">$${parseFloat(price.price).toFixed(2)}</div>
                            <div class="stock-change ${changeClass}">
                                ${changeSymbol}${change.toFixed(2)} (${changeSymbol}${parseFloat(price.changePercent).toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Volume</div>
                            <div class="metric-value">${(parseInt(price.volume) / 1000000).toFixed(1)}M</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">High</div>
                            <div class="metric-value">$${parseFloat(price.high).toFixed(2)}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Low</div>
                            <div class="metric-value">$${parseFloat(price.low).toFixed(2)}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Prev Close</div>
                            <div class="metric-value">$${parseFloat(price.previousClose).toFixed(2)}</div>
                        </div>
                    </div>
            `;
            
            // Add technical indicators section
            if (technical) {
                cardHTML += `
                    <div class="technical-section">
                        <div class="technical-title">üìä Technical Indicators</div>
                        <div class="indicators-grid">
                `;
                
                if (technical.rsi) {
                    const rsiSignal = technical.rsi.value > 70 ? 'overbought' : technical.rsi.value < 30 ? 'oversold' : 'neutral';
                    const rsiClass = technical.rsi.value > 70 ? 'bearish' : technical.rsi.value < 30 ? 'bullish' : 'neutral';
                    cardHTML += `
                        <div class="indicator-card">
                            <div class="indicator-label">RSI (14)</div>
                            <div class="indicator-value">${technical.rsi.value.toFixed(1)}</div>
                            <div class="indicator-signal ${rsiClass}">${rsiSignal}</div>
                        </div>
                    `;
                }
                
                if (technical.macd) {
                    const macdClass = technical.macd.crossover === 'Bullish' ? 'bullish' : 'bearish';
                    cardHTML += `
                        <div class="indicator-card">
                            <div class="indicator-label">MACD</div>
                            <div class="indicator-value">${technical.macd.macd.toFixed(3)}</div>
                            <div class="indicator-signal ${macdClass}">${technical.macd.crossover}</div>
                        </div>
                    `;
                }
                
                if (technical.sma20) {
                    const smaSignal = price.price > technical.sma20.value ? 'Above' : 'Below';
                    const smaClass = price.price > technical.sma20.value ? 'bullish' : 'bearish';
                    cardHTML += `
                        <div class="indicator-card">
                            <div class="indicator-label">SMA (20)</div>
                            <div class="indicator-value">$${technical.sma20.value.toFixed(2)}</div>
                            <div class="indicator-signal ${smaClass}">${smaSignal}</div>
                        </div>
                    `;
                }
                
                if (technical.bollingerBands) {
                    const bbSignal = price.price > technical.bollingerBands.upper ? 'Above Upper' : 
                                    price.price < technical.bollingerBands.lower ? 'Below Lower' : 'Within Bands';
                    const bbClass = price.price > technical.bollingerBands.upper ? 'bullish' : 
                                   price.price < technical.bollingerBands.lower ? 'bearish' : 'neutral';
                    cardHTML += `
                        <div class="indicator-card">
                            <div class="indicator-label">Bollinger Bands</div>
                            <div class="indicator-value">$${technical.bollingerBands.middle.toFixed(2)}</div>
                            <div class="indicator-signal ${bbClass}">${bbSignal}</div>
                        </div>
                    `;
                }
                
                cardHTML += `</div></div>`;
            }
            
            // Add smart signals section
            if (smartSignals && smartSignals.signals && smartSignals.signals.length > 0) {
                cardHTML += `
                    <div class="technical-section">
                        <div class="technical-title">üß† Smart Signals</div>
                        <div style="background: rgba(0, 122, 255, 0.1); border-radius: 12px; padding: 12px;">
                `;
                
                smartSignals.signals.slice(0, 3).forEach(signal => {
                    cardHTML += `<div style="font-size: 13px; margin-bottom: 8px;">‚Ä¢ ${signal.message}</div>`;
                });
                
                cardHTML += `</div></div>`;
            }
            
            cardHTML += `</div>`;
            resultsContainer.innerHTML = cardHTML;
        }

        // Load smart plays from new function
        async function loadSmartPlays(filterType = 'all') {
            const playsContainer = document.getElementById('playsContent');
            playsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Generating intelligent trading opportunities...</div>';
            
            try {
                const response = await fetch(`/.netlify/functions/smart-plays?type=${filterType}&risk=medium&timeframe=short`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displaySmartPlays(data.plays);
                
            } catch (error) {
                console.error('Smart plays error:', error);
                playsContainer.innerHTML = '<div class="error">Unable to load smart plays. Please try again.</div>';
            }
        }

        // Display smart plays
        function displaySmartPlays(plays) {
            const playsContainer = document.getElementById('playsContent');
            
            if (!plays || plays.length === 0) {
                playsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">No plays available at this time. Market analysis in progress.</div>';
                return;
            }
            
            let playsHTML = '';
            plays.slice(0, 10).forEach(play => {
                const confidencePercent = Math.round(play.confidence * 100);
                const returnPercent = Math.round(play.potentialReturn * 100);
                
                playsHTML += `
                    <div class="play-item">
                        <div class="play-header">
                            <div class="play-symbol">${play.symbol}</div>
                            <div class="play-confidence">${confidencePercent}% confidence</div>
                        </div>
                        <div class="play-strategy">${play.strategy}</div>
                        <div class="play-description">${play.type} - ${play.direction.replace('_', ' ')}</div>
                        
                        <div class="play-details">
                            <div class="play-detail">
                                <div class="metric-label">Potential Return</div>
                                <div class="metric-value">${returnPercent}%</div>
                            </div>
                            <div class="play-detail">
                                <div class="metric-label">Risk Level</div>
                                <div class="metric-value">${play.risk}</div>
                            </div>
                            <div class="play-detail">
                                <div class="metric-label">Timeframe</div>
                                <div class="metric-value">${play.timeframe}</div>
                            </div>
                            <div class="play-detail">
                                <div class="metric-label">Probability</div>
                                <div class="metric-value">${Math.round(play.probability * 100)}%</div>
                            </div>
                        </div>
                        
                        ${play.reasoning ? `
                            <div class="reasoning-list">
                                ${play.reasoning.slice(0, 3).map(reason => `<div class="reasoning-item">${reason}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            playsContainer.innerHTML = playsHTML;
        }

        // Load smart alerts from new function
        async function loadSmartAlerts() {
            const alertsContainer = document.getElementById('alertsContent');
            alertsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Scanning market for intelligent alerts...</div>';
            
            try {
                const response = await fetch('/.netlify/functions/smart-alerts');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displaySmartAlerts(data.alerts);
                
            } catch (error) {
                console.error('Smart alerts error:', error);
                alertsContainer.innerHTML = '<div class="error">Unable to load smart alerts. Please try again.</div>';
            }
        }

        // Display smart alerts
        function displaySmartAlerts(alerts) {
            const alertsContainer = document.getElementById('alertsContent');
            
            if (!alerts || alerts.length === 0) {
                alertsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">No active alerts. Market monitoring in progress.</div>';
                return;
            }
            
            let alertsHTML = '';
            alerts.slice(0, 15).forEach(alert => {
                const priorityClass = alert.priority >= 7 ? 'high' : alert.priority >= 5 ? 'medium' : 'low';
                const timeAgo = getTimeAgo(new Date(alert.timestamp));
                
                alertsHTML += `
                    <div class="alert-item">
                        <div class="alert-priority ${priorityClass}"></div>
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-meta">
                            <span>${alert.symbol} ‚Ä¢ ${alert.type}</span>
                            <span>${timeAgo}</span>
                        </div>
                    </div>
                `;
            });
            
            alertsContainer.innerHTML = alertsHTML;
        }

        // Refresh alerts
        async function refreshAlerts() {
            await loadSmartAlerts();
        }

        // Update analysis tab with comprehensive data
        function updateAnalysisTab(ticker, data) {
            const content = document.getElementById('analysisContent');
            
            if (!data.price) {
                content.innerHTML = 'No comprehensive data available for analysis.';
                return;
            }
            
            const { price, technical, smartSignals } = data;
            const changePercent = parseFloat(price.changePercent);
            
            let analysis = `<strong>${ticker} Advanced Technical Analysis</strong><br><br>`;
            
            // Price action analysis
            analysis += `<strong>üìä Price Action:</strong><br>`;
            analysis += `Current: $${price.price.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)<br>`;
            analysis += `Range: $${price.low.toFixed(2)} - $${price.high.toFixed(2)}<br>`;
            analysis += `Volume: ${(price.volume / 1000000).toFixed(1)}M shares<br><br>`;
            
            // Technical indicators
            if (technical) {
                analysis += `<strong>üî¨ Technical Indicators:</strong><br>`;
                
                if (technical.rsi) {
                    analysis += `RSI (14): ${technical.rsi.value.toFixed(1)} - ${technical.rsi.value > 70 ? 'Overbought' : technical.rsi.value < 30 ? 'Oversold' : 'Neutral'}<br>`;
                }
                
                if (technical.macd) {
                    analysis += `MACD: ${technical.macd.crossover} crossover (Histogram: ${technical.macd.histogram.toFixed(3)})<br>`;
                }
                
                if (technical.sma20 && technical.sma50) {
                    analysis += `SMA (20): $${technical.sma20.value.toFixed(2)}<br>`;
                    analysis += `SMA (50): $${technical.sma50.value.toFixed(2)}<br>`;
                }
                
                if (technical.bollingerBands) {
                    analysis += `Bollinger Bands: $${technical.bollingerBands.lower.toFixed(2)} - $${technical.bollingerBands.upper.toFixed(2)}<br>`;
                }
                
                analysis += '<br>';
            }
            
            // Smart signals
            if (smartSignals && smartSignals.signals) {
                analysis += `<strong>üß† Smart Analysis (${smartSignals.overall.toUpperCase()}):</strong><br>`;
                smartSignals.signals.slice(0, 4).forEach(signal => {
                    analysis += `‚Ä¢ ${signal.message}<br>`;
                });
                analysis += '<br>';
            }
            
            // Trading recommendations
            analysis += `<strong>üí° Trading Recommendations:</strong><br>`;
            if (smartSignals && smartSignals.plays && smartSignals.plays.length > 0) {
                smartSignals.plays.slice(0, 3).forEach(play => {
                    analysis += `‚Ä¢ ${play.strategy}: ${play.reason}<br>`;
                });
            } else {
                analysis += '‚Ä¢ Monitor for technical breakout opportunities<br>';
                analysis += '‚Ä¢ Consider volatility-based strategies<br>';
                analysis += '‚Ä¢ Apply proper risk management<br>';
            }
            
            content.innerHTML = analysis;
        }

        // Load comprehensive market data
        async function loadMarketData() {
            try {
                // Load major indices with comprehensive data
                const [spyData, qqqData] = await Promise.allSettled([
                    getComprehensiveStockData('SPY'),
                    getComprehensiveStockData('QQQ')
                ]);
                
                if (spyData.status === 'fulfilled' && spyData.value?.price) {
                    const spy = spyData.value.price;
                    document.getElementById('spyPrice').textContent = `$${spy.price.toFixed(2)}`;
                    const spySignal = spy.changePercent > 1 ? 'bullish' : spy.changePercent < -1 ? 'bearish' : 'neutral';
                    document.getElementById('spySignal').textContent = spy.changePercent > 0 ? `+${spy.changePercent.toFixed(1)}%` : `${spy.changePercent.toFixed(1)}%`;
                    document.getElementById('spySignal').className = `indicator-signal ${spySignal}`;
                }
                
                if (qqqData.status === 'fulfilled' && qqqData.value?.price) {
                    const qqq = qqqData.value.price;
                    document.getElementById('qqqPrice').textContent = `$${qqq.price.toFixed(2)}`;
                    const qqqSignal = qqq.changePercent > 1 ? 'bullish' : qqq.changePercent < -1 ? 'bearish' : 'neutral';
                    document.getElementById('qqqSignal').textContent = qqq.changePercent > 0 ? `+${qqq.changePercent.toFixed(1)}%` : `${qqq.changePercent.toFixed(1)}%`;
                    document.getElementById('qqqSignal').className = `indicator-signal ${qqqSignal}`;
                }
                
                // VIX estimation (in production, you'd use real VIX data)
                document.getElementById('vixPrice').textContent = '18.5';
                document.getElementById('vixSignal').textContent = 'Normal';
                document.getElementById('vixSignal').className = 'indicator-signal neutral';
                
                // Market sentiment
                if (spyData.status === 'fulfilled' && spyData.value?.price) {
                    const spyChange = spyData.value.price.changePercent;
                    let sentiment = 'Neutral';
                    let sentimentClass = 'neutral';
                    
                    if (spyChange > 1) {
                        sentiment = 'Bullish';
                        sentimentClass = 'bullish';
                    } else if (spyChange < -1) {
                        sentiment = 'Bearish';
                        sentimentClass = 'bearish';
                    }
                    
                    document.getElementById('sentiment').textContent = sentiment;
                    document.getElementById('sentimentSignal').textContent = `${spyChange >= 0 ? '+' : ''}${spyChange.toFixed(1)}%`;
                    document.getElementById('sentimentSignal').className = `indicator-signal ${sentimentClass}`;
                }
                
                updateDataStatus();
                
            } catch (error) {
                console.error('Market data error:', error);
            }
        }

        // Update data status indicator
        function updateDataStatus() {
            const statusDot = document.getElementById('dataStatus');
            
            // Check if we're getting real-time data
            if (isDataLive) {
                statusDot.className = 'status-dot live';
                statusDot.title = 'Real-time data active';
            } else {
                statusDot.className = 'status-dot delayed';
                statusDot.title = '15-minute delayed data';
            }
        }

        // Helper functions
        function extractTicker(message) {
            const words = message.toUpperCase().split(/\s+/);
            const tickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX', 'HOOD', 'SPY', 'QQQ', 'IWM', 'AMD', 'INTC', 'DIS', 'JPM', 'BAC', 'WMT', 'V', 'MA'];
            
            for (const word of words) {
                if (tickers.includes(word) || /^[A-Z]{1,5}$/.test(word)) {
                    return word;
                }
            }
            return null;
        }

        function addMessage(text, sender, isTyping = false) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg_' + Date.now();
            
            messageDiv.id = messageId;
            messageDiv.className = `message ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (isTyping) {
                bubble.innerHTML = '<div class="spinner"></div>' + text;
            } else {
                const formatted = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                bubble.innerHTML = formatted;
            }
            
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            return messageId;
        }

        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) message.remove();
        }

        function showStockError(message) {
            const resultsContainer = document.getElementById('stockResults');
            resultsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        document.getElementById('tickerInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // PWA and mobile optimizations
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        
        // Disable iOS bounce scrolling
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.messages') || e.target.closest('.tab-pane')) {
                return; // Allow scrolling in content areas
            }
            e.preventDefault();
        }, {passive: false});
        
    </script>
</body>
</html>
