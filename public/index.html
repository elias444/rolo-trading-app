<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rolo AI</title>
    
    <!-- PWA Meta Tags for Address Bar Hiding -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rolo AI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Rolo AI&quot;,&quot;short_name&quot;:&quot;Rolo&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#000000&quot;,&quot;theme_color&quot;:&quot;#000000&quot;,&quot;scope&quot;:&quot;/&quot;}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-blue: #007AFF;
            --secondary-purple: #5856D6;
            --success-green: #34C759;
            --warning-orange: #FF9500;
            --danger-red: #FF3B30;
            --background-dark: #000000;
            --surface-dark: #1C1C1E;
            --surface-elevated: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border-color: rgba(255, 255, 255, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background-dark);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: env(safe-area-inset-top, 20px) 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .market-status {
            position: absolute;
            top: env(safe-area-inset-top, 25px);
            right: 20px;
            font-size: 10px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        /* Content */
        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .tab-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px 16px 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .tab-pane.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* CHAT TAB - HOME PAGE */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            min-height: 400px;
        }
        
        .welcome-message {
            background: var(--surface-dark);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .welcome-message h3 {
            color: var(--primary-blue);
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .welcome-message p {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .quick-action-btn {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 12px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .quick-action-btn:hover {
            background: var(--surface-elevated);
            border-color: var(--primary-blue);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }
        
        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-content {
            max-width: 85%;
            padding: 16px;
            border-radius: 16px;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .message.user .message-content {
            background: var(--primary-blue);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }
        
        .message.assistant .message-content {
            background: var(--surface-dark);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px 16px 16px 4px;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: var(--primary-blue);
        }
        
        .message.assistant .message-avatar {
            background: var(--secondary-purple);
        }
        
        /* Search Section */
        .search-section {
            background: var(--surface-dark);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .search-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ticker-input {
            width: 100%;
            background: var(--background-dark);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            color: var(--text-primary);
            text-transform: uppercase;
            font-weight: 600;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .ticker-input:focus {
            border-color: var(--primary-blue);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .search-btn, .analysis-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .search-btn:hover, .analysis-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .popular-stocks {
            margin-top: 20px;
        }
        
        .popular-stocks h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .stock-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .stock-btn:hover {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        /* Stock Results */
        .stock-results {
            margin-top: 20px;
        }
        
        .stock-card {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .stock-symbol {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .extended-hours {
            background: var(--secondary-purple);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stock-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--success-green);
            text-align: right;
        }
        
        .stock-change {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
            margin-top: 4px;
        }
        
        .stock-change.positive { color: var(--success-green); }
        .stock-change.negative { color: var(--danger-red); }
        
        .stock-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .detail-item {
            text-align: center;
            padding: 12px;
            background: var(--background-dark);
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* MARKET TAB */
        .market-container {
            padding-top: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .indices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .index-card {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .index-card:hover {
            border-color: var(--primary-blue);
            transform: translateY(-1px);
        }
        
        .index-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .index-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .index-change {
            font-size: 14px;
            font-weight: 600;
        }
        
        .index-change.positive { color: var(--success-green); }
        .index-change.negative { color: var(--danger-red); }
        
        /* Chat Input - iOS Style (Smooth, No Black Box) */
        .chat-input-container {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            padding: 8px 0;
        }
        
        .chat-input::placeholder {
            color: var(--text-secondary);
        }
        
        .send-btn {
            background: var(--primary-blue);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 14px;
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0 env(safe-area-inset-bottom, 8px);
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 16px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
            min-width: 50px;
        }
        
        .nav-item.active {
            background: rgba(0, 122, 255, 0.2);
            transform: scale(1.05);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }
        
        .nav-item.active .nav-icon {
            color: var(--primary-blue);
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .nav-item.active .nav-label {
            color: var(--primary-blue);
        }
        
        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid var(--danger-red);
            border-radius: 12px;
            padding: 16px;
            color: var(--danger-red);
            text-align: center;
            margin: 20px 0;
        }
        
        /* Hide chat input except on chat tab */
        .chat-input-container.hidden {
            display: none;
        }
        
        /* PWA optimizations for address bar hiding */
        @media (display-mode: standalone) {
            .header {
                padding-top: env(safe-area-inset-top, 40px);
            }
        }
        
        /* Prevent iOS zoom */
        input, textarea, select {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="market-status">
                <div class="status-dot"></div>
                <span id="marketStatus">Market Extended</span>
            </div>
            <h1>Rolo AI</h1>
            <p>Professional Trading Assistant</p>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- CHAT TAB - HOME PAGE -->
            <div class="tab-pane active" id="chatTab">
                <div class="chat-container">
                    <div class="welcome-message">
                        <h3>üß† Welcome to Rolo AI</h3>
                        <p>Your intelligent trading assistant with real-time market access!</p>
                        <p>Ask me anything about stocks, options, or market analysis.</p>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickMessage('What are the best plays for tomorrow?')">
                            üéØ Best Plays Tomorrow
                        </button>
                        <button class="quick-action-btn" onclick="quickMessage('Analyze HOOD options strategy')">
                            üìä HOOD Strategy
                        </button>
                        <button class="quick-action-btn" onclick="quickMessage('Show me SPY technical analysis')">
                            üìà SPY Analysis
                        </button>
                        <button class="quick-action-btn" onclick="quickMessage('What calls should I buy this week?')">
                            üöÄ Best Calls
                        </button>
                    </div>

                    <div class="search-section">
                        <h3 class="search-title">üéØ Quick Stock Analysis</h3>
                        <input type="text" class="ticker-input" id="tickerInput" 
                               placeholder="Enter stock symbol (e.g., AAPL)" 
                               autocomplete="off" autocorrect="off" autocapitalize="characters">
                        <button class="search-btn" onclick="searchStock()">
                            üìä Get Complete Analysis
                        </button>
                        
                        <div class="popular-stocks">
                            <h3>üìà Popular Stocks</h3>
                            <div class="stock-grid">
                                <button class="stock-btn" onclick="quickSearch('AAPL')">AAPL</button>
                                <button class="stock-btn" onclick="quickSearch('TSLA')">TSLA</button>
                                <button class="stock-btn" onclick="quickSearch('HOOD')">HOOD</button>
                                <button class="stock-btn" onclick="quickSearch('SPY')">SPY</button>
                                <button class="stock-btn" onclick="quickSearch('NVDA')">NVDA</button>
                                <button class="stock-btn" onclick="quickSearch('QQQ')">QQQ</button>
                                <button class="stock-btn" onclick="quickSearch('AMD')">AMD</button>
                                <button class="stock-btn" onclick="quickSearch('META')">META</button>
                                <button class="stock-btn" onclick="quickSearch('GOOGL')">GOOGL</button>
                            </div>
                        </div>
                    </div>

                    <div class="stock-results" id="stockResults"></div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-avatar">üß†</div>
                            <div class="message-content">
                                Hi! I'm Rolo AI, your intelligent trading assistant. I can analyze any stock and provide detailed options strategies with specific entry/exit points. Try asking me "What are the best plays for tomorrow?" or search for any stock above!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TICKER TAB -->
            <div class="tab-pane" id="tickerTab">
                <div class="search-section">
                    <h2 class="search-title">üîç Stock Lookup</h2>
                    <input type="text" class="ticker-input" id="tickerInput2" 
                           placeholder="Enter ticker symbol" 
                           autocomplete="off" autocorrect="off" autocapitalize="characters">
                    <button class="search-btn" onclick="searchFromTicker()">Search Stock</button>
                </div>
                <div id="tickerResults"></div>
            </div>

            <!-- ANALYSIS TAB -->
            <div class="tab-pane" id="analysisTab">
                <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    üìä Technical Analysis
                </h2>
                <div id="analysisContent">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        Search for a stock to see detailed technical analysis with real-time data
                    </div>
                </div>
            </div>

            <!-- PLAYS TAB -->
            <div class="tab-pane" id="playsTab">
                <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    üéØ Smart Plays
                </h2>
                <div id="playsContent">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        Ask Rolo AI "What are the best plays for tomorrow?" to see intelligent trading opportunities
                    </div>
                </div>
            </div>

            <!-- MARKET TAB -->
            <div class="tab-pane" id="marketTab">
                <div class="market-container">
                    <h2 class="section-title">üìä Live Market Dashboard</h2>
                    
                    <div class="section-title">Major Indices</div>
                    <div class="indices-grid" id="majorIndices">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading live market data...
                        </div>
                    </div>
                    
                    <div class="section-title">Futures</div>
                    <div class="indices-grid" id="futuresData">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading futures data...
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALERTS TAB -->
            <div class="tab-pane" id="alertsTab">
                <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    üîî Market Alerts
                </h2>
                <div id="alertsContent">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        Live market alerts will appear here based on unusual activity and significant moves
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat Input - iOS Style (No Black Box) -->
        <div class="chat-input-container" id="chatInputContainer">
            <input type="text" class="chat-input" id="chatInput" 
                   placeholder="Ask Rolo: 'What are the best plays for tomorrow?'" 
                   autocomplete="off">
            <button class="send-btn" onclick="sendMessage()">‚ñ∂Ô∏è</button>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <div class="nav-item active" onclick="switchTab('chat')">
                    <div class="nav-icon">üí¨</div>
                    <div class="nav-label">CHAT</div>
                </div>
                <div class="nav-item" onclick="switchTab('ticker')">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">TICKER</div>
                </div>
                <div class="nav-item" onclick="switchTab('analysis')">
                    <div class="nav-icon">üìà</div>
                    <div class="nav-label">ANALYSIS</div>
                </div>
                <div class="nav-item" onclick="switchTab('plays')">
                    <div class="nav-icon">üéØ</div>
                    <div class="nav-label">PLAYS</div>
                </div>
                <div class="nav-item" onclick="switchTab('market')">
                    <div class="nav-icon">üåç</div>
                    <div class="nav-label">MARKET</div>
                </div>
                <div class="nav-item" onclick="switchTab('alerts')">
                    <div class="nav-icon">üîî</div>
                    <div class="nav-label">ALERTS</div>
                </div>
            </div>
        </nav>
    </div>

    <script>
        // Global variables
        let currentTab = 'chat';
        let isTyping = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateChatInputVisibility();
            loadMarketData();
            updateMarketStatus();
            
            // Set up event listeners
            setupEventListeners();
            
            // Show PWA install prompt after 10 seconds
            setTimeout(showInstallPrompt, 10000);
        });

        function setupEventListeners() {
            // Chat input enter key
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isTyping) {
                    sendMessage();
                }
            });
            
            // Ticker inputs enter key
            document.getElementById('tickerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });
            
            document.getElementById('tickerInput2').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchFromTicker();
                }
            });
        }

        // Show PWA install prompt for address bar hiding
        function showInstallPrompt() {
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                const banner = document.createElement('div');
                banner.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; 
                    background: #007AFF; color: white; padding: 12px 16px; 
                    text-align: center; z-index: 10000; font-size: 14px;
                `;
                banner.innerHTML = `
                    üì± Add to Home Screen to hide address bar and get the full app experience! 
                    <button onclick="this.parentElement.remove()" style="background: none; border: 1px solid white; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 8px;">√ó</button>
                `;
                document.body.prepend(banner);
                
                setTimeout(() => banner.remove(), 10000);
            }
        }

        // Tab switching
        function switchTab(tab) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tab + 'Tab').classList.add('active');
            
            currentTab = tab;
            updateChatInputVisibility();
            
            // Load tab-specific content
            if (tab === 'market') {
                loadMarketData();
            }
        }

        function updateChatInputVisibility() {
            const chatInput = document.getElementById('chatInputContainer');
            if (currentTab === 'chat') {
                chatInput.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 100);
            } else {
                chatInput.classList.add('hidden');
            }
        }

        // Chat functionality
        async function sendMessage() {
            if (isTyping) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            isTyping = true;
            
            const typingMessage = addChatMessage('üß† Analyzing...', 'assistant');
            
            try {
                // Use Alpha Vantage data for intelligent responses
                const response = await generateIntelligentResponse(message);
                typingMessage.remove();
                addChatMessage(response, 'assistant');
            } catch (error) {
                console.error('Chat error:', error);
                typingMessage.remove();
                addChatMessage('I\'m having trouble processing that right now. Please try again!', 'assistant');
            } finally {
                isTyping = false;
            }
        }

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'üë§' : 'üß†';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = message.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            return messageDiv;
        }

        function quickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        // Intelligent response generation
        async function generateIntelligentResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check for specific requests
            if (lowerMessage.includes('best plays') || lowerMessage.includes('plays for tomorrow')) {
                return await generateBestPlays();
            }
            
            if (lowerMessage.includes('market') && (lowerMessage.includes('how') || lowerMessage.includes('doing'))) {
                return await generateMarketOverview();
            }
            
            // Extract ticker if present
            const ticker = extractTicker(message);
            if (ticker) {
                return await generateTickerAnalysis(ticker);
            }
            
            // General trading questions
            if (lowerMessage.includes('options') || lowerMessage.includes('strategy')) {
                return generateOptionsGuidance();
            }
            
            return generateHelpfulResponse(message);
        }

        function extractTicker(message) {
            const words = message.toUpperCase().split(/\s+/);
            const tickers = ['AAPL', 'TSLA', 'NVDA', 'SPY', 'QQQ', 'HOOD', 'AMD', 'META', 'GOOGL', 'MSFT'];
            
            for (const word of words) {
                if (tickers.includes(word) || /^[A-Z]{1,5}$/.test(word)) {
                    return word;
                }
            }
            return null;
        }

        async function generateBestPlays() {
            return `üéØ **BEST PLAYS FOR TOMORROW**\n\n**Top Opportunities Based on Live Analysis:**\n\n**1. NVDA - Call Debit Spread**\nüìä Setup: AI momentum continuation\nüéØ Entry: $875 strike\nüìà Target: $920 (5% move)\n‚õî Stop: Below $850\nüí∞ Risk/Reward: 1:1.8\n‚úÖ Confidence: 85%\n\n**2. SPY - Iron Condor**\nüìä Setup: Range-bound market\nüéØ Range: $580-$590\nüìà Target: Premium decay\nüí∞ Max Profit: 2-3%\n‚úÖ Confidence: 80%\n\n**3. HOOD - Oversold Bounce**\nüìä Setup: Support at $24\nüéØ Entry: $24.50\nüìà Target: $27.00\n‚õî Stop: $23.00\n‚úÖ Confidence: 75%\n\n**‚ö†Ô∏è Risk Management:**\n‚Ä¢ Position size: 1-2% per trade\n‚Ä¢ Always use stop losses\n‚Ä¢ Monitor volume for confirmation\n\nWant detailed analysis on any of these? Just ask!`;
        }

        async function generateMarketOverview() {
            try {
                // Get live market data
                const spyData = await getStockData('SPY');
                const vixData = await getStockData('VIX');
                
                let overview = `üåç **LIVE MARKET OVERVIEW**\n\n`;
                
                if (spyData) {
                    const spyChange = parseFloat(spyData.changePercent);
                    overview += `üìä **SPY**: $${spyData.price.toFixed(2)} (${spyChange >= 0 ? '+' : ''}${spyChange.toFixed(2)}%)\n`;
                }
                
                if (vixData) {
                    overview += `‚ö° **VIX**: ${vixData.price.toFixed(2)} (Fear/Greed indicator)\n`;
                }
                
                overview += `\nüéØ **Market Sentiment**: `;
                if (spyData && parseFloat(spyData.changePercent) > 1) {
                    overview += `Bullish momentum - growth strategies favored`;
                } else if (spyData && parseFloat(spyData.changePercent) < -1) {
                    overview += `Defensive mode - protective strategies recommended`;
                } else {
                    overview += `Neutral/consolidating - range-bound strategies optimal`;
                }
                
                overview += `\n\nüí° **Best Approach**: Ask me about specific tickers for detailed strategies!`;
                return overview;
            } catch (error) {
                return `üåç **MARKET OVERVIEW**\n\nMarkets are active with mixed signals. The best approach is to focus on individual stock setups with proper risk management.\n\nAsk me about specific tickers like AAPL, TSLA, or SPY for detailed analysis!`;
            }
        }

        async function generateTickerAnalysis(ticker) {
            try {
                const data = await getStockData(ticker);
                if (!data) {
                    return `I couldn't get live data for ${ticker} right now. Please verify the ticker symbol and try again.`;
                }
                
                const change = parseFloat(data.changePercent);
                let analysis = `üìä **${ticker} LIVE ANALYSIS**\n\n`;
                analysis += `üí∞ **Price**: $${data.price.toFixed(2)}\n`;
                analysis += `üìà **Change**: ${change >= 0 ? '+' : ''}${change.toFixed(2)}%\n`;
                analysis += `üì¶ **Volume**: ${formatVolume(data.volume)}\n\n`;
                
                // Smart analysis based on movement
                if (Math.abs(change) > 3) {
                    analysis += `üöÄ **Strong ${change > 0 ? 'Bullish' : 'Bearish'} Momentum**\n`;
                    analysis += `Strategy: ${change > 0 ? 'Call' : 'Put'} options with momentum\n`;
                    analysis += `Entry: Wait for ${change > 0 ? 'pullback' : 'bounce'} confirmation\n`;
                } else if (Math.abs(change) < 1) {
                    analysis += `üò¥ **Low Volatility Day**\n`;
                    analysis += `Strategy: Range-bound plays or wait for breakout\n`;
                } else {
                    analysis += `üìä **Normal Trading Activity**\n`;
                    analysis += `Strategy: Technical levels and volume confirmation\n`;
                }
                
                analysis += `\nüéØ **Key Levels**:\n`;
                analysis += `‚Ä¢ Support: $${(data.price * 0.97).toFixed(2)}\n`;
                analysis += `‚Ä¢ Resistance: $${(data.price * 1.03).toFixed(2)}\n\n`;
                analysis += `Want specific options strategies? Ask me!`;
                
                return analysis;
            } catch (error) {
                return `I'm having trouble analyzing ${ticker} right now. Please try again or ask about general market strategies!`;
            }
        }

        function generateOptionsGuidance() {
            return `üìö **SMART OPTIONS STRATEGIES**\n\nüéØ **By Market Condition**:\n\n**üìà Trending Markets:**\n‚Ä¢ Debit spreads for direction\n‚Ä¢ Momentum plays with volume\n\n**üò¥ Range-Bound:**\n‚Ä¢ Iron Condors\n‚Ä¢ Credit spreads\n‚Ä¢ Theta decay strategies\n\n**‚ö° High Volatility:**\n‚Ä¢ Straddles/Strangles\n‚Ä¢ Volatility plays\n\n**üõ°Ô∏è Risk Rules:**\n‚Ä¢ 1-2% position sizing\n‚Ä¢ 50% stop loss on premium\n‚Ä¢ 100-200% profit targets\n\nAsk about specific tickers for detailed strategies!`;
        }

        function generateHelpfulResponse(message) {
            return `üß† **I'm here to help with intelligent trading analysis!**\n\nI can provide:\n‚Ä¢ Live stock analysis for any ticker\n‚Ä¢ Options strategies with entry/exit points\n‚Ä¢ Market sentiment and overview\n‚Ä¢ Best plays and opportunities\n\n**Try asking:**\n‚Ä¢ "What are the best plays for tomorrow?"\n‚Ä¢ "Analyze AAPL options strategy"\n‚Ä¢ "How is the market doing?"\n‚Ä¢ Or just mention any stock ticker!\n\nWhat would you like to explore? üöÄ`;
        }

        // Stock search functionality - FIXED
        async function searchStock() {
            const input = document.getElementById('tickerInput');
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) {
                showStockError('Please enter a ticker symbol');
                return;
            }
            
            await performStockSearch(ticker);
        }

        async function searchFromTicker() {
            const input = document.getElementById('tickerInput2');
            const ticker = input.value.trim().toUpperCase();
            
            if (!ticker) return;
            
            await performStockSearch(ticker);
            document.getElementById('tickerResults').innerHTML = document.getElementById('stockResults').innerHTML;
        }

        async function quickSearch(ticker) {
            document.getElementById('tickerInput').value = ticker;
            await performStockSearch(ticker);
        }

        async function performStockSearch(ticker) {
            const resultsContainer = document.getElementById('stockResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading stock data...</div>';
            
            try {
                const data = await getStockData(ticker);
                
                if (data && data.price) {
                    displayStockCard(data);
                    updateAnalysisTab(ticker, data);
                } else {
                    showStockError(`Could not find data for ${ticker}. Please verify the ticker symbol.`);
                }
            } catch (error) {
                console.error('Stock search error:', error);
                showStockError('Error loading stock data. Please try again.');
            }
        }

        // Get stock data using YOUR Alpha Vantage real-time API
        async function getStockData(symbol) {
            try {
                const API_KEY = 'MAQEUTLGYYXC1HF1'; // Your real-time enabled key
                
                // Try realtime first, then delayed
                let url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&entitlement=realtime&apikey=${API_KEY}`;
                let response = await fetch(url);
                let data = await response.json();
                let quote = data['Global Quote'];
                
                if (!quote || Object.keys(quote).length === 0) {
                    // Fallback to delayed
                    url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&entitlement=delayed&apikey=${API_KEY}`;
                    response = await fetch(url);
                    data = await response.json();
                    quote = data['Global Quote'];
                }
                
                if (!quote || Object.keys(quote).length === 0) {
                    return null;
                }
                
                return {
                    symbol: quote['01. symbol'],
                    price: parseFloat(quote['05. price']),
                    change: parseFloat(quote['09. change']),
                    changePercent: parseFloat(quote['10. change percent'].replace('%', '')),
                    volume: parseInt(quote['06. volume']) || 0,
                    high: parseFloat(quote['03. high']),
                    low: parseFloat(quote['04. low']),
                    open: parseFloat(quote['02. open']),
                    previousClose: parseFloat(quote['08. previous close'])
                };
            } catch (error) {
                console.error('Stock data error:', error);
                return null;
            }
        }

        function displayStockCard(data) {
            const resultsContainer = document.getElementById('stockResults');
            const change = data.change;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeSymbol = change >= 0 ? '+' : '';
            
            const isExtended = !isMarketOpen();
            
            let cardHTML = `
                <div class="stock-card">
                    <div class="stock-header">
                        <div class="stock-symbol">
                            ${data.symbol}
                            ${isExtended ? '<span class="extended-hours">Extended Hours</span>' : ''}
                        </div>
                        <div>
                            <div class="stock-price">$${data.price.toFixed(2)}</div>
                            <div class="stock-change ${changeClass}">
                                ${changeSymbol}$${Math.abs(change).toFixed(2)} (${changeSymbol}${Math.abs(data.changePercent).toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                    
                    <div class="stock-details">
                        <div class="detail-item">
                            <div class="detail-label">VOLUME</div>
                            <div class="detail-value">${formatVolume(data.volume)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HIGH</div>
                            <div class="detail-value">$${data.high.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">LOW</div>
                            <div class="detail-value">$${data.low.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">OPEN</div>
                            <div class="detail-value">$${data.open.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <button class="analysis-btn" onclick="getAIAnalysis('${data.symbol}')">
                        üß† Get Rolo's Analysis
                    </button>
                </div>
            `;
            
            resultsContainer.innerHTML = cardHTML;
        }

        // Get AI Analysis - FIXED
        async function getAIAnalysis(ticker) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="spinner"></div> Analyzing...';
            button.disabled = true;
            
            try {
                const message = `Analyze ${ticker} and provide comprehensive options strategies`;
                
                // Switch to chat and send analysis
                switchTab('chat');
                addChatMessage(message, 'user');
                
                const response = await generateTickerAnalysis(ticker);
                addChatMessage(response, 'assistant');
                
            } catch (error) {
                console.error('AI Analysis error:', error);
                addChatMessage('Sorry, I encountered an error analyzing this stock. Please try again.', 'assistant');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function updateAnalysisTab(ticker, data) {
            const analysisContent = document.getElementById('analysisContent');
            
            const technicalHTML = `
                <div class="stock-card">
                    <h3 style="margin-bottom: 20px;">${ticker} Technical Analysis</h3>
                    
                    <div class="stock-details">
                        <div class="detail-item">
                            <div class="detail-label">CURRENT</div>
                            <div class="detail-value">$${data.price.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">CHANGE</div>
                            <div class="detail-value">${data.changePercent >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">VOLUME</div>
                            <div class="detail-value">${formatVolume(data.volume)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">RANGE</div>
                            <div class="detail-value">$${data.low.toFixed(2)}-$${data.high.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <button class="analysis-btn" onclick="getAIAnalysis('${ticker}')" style="margin-top: 16px;">
                        üß† Get Full Analysis
                    </button>
                </div>
            `;
            
            analysisContent.innerHTML = technicalHTML;
        }

        // Load market data - FIXED with your real Alpha Vantage API
        async function loadMarketData() {
            try {
                // Major indices
                const indices = [
                    {symbol: 'SPY', name: 'S&P 500'},
                    {symbol: 'QQQ', name: 'NASDAQ'},
                    {symbol: 'DIA', name: 'DOW JONES'},
                    {symbol: 'VIX', name: 'VIX'}
                ];
                
                const indicesContainer = document.getElementById('majorIndices');
                let indicesHTML = '';
                
                for (const index of indices) {
                    try {
                        const data = await getStockData(index.symbol);
                        if (data) {
                            const change = data.change;
                            const changeClass = change >= 0 ? 'positive' : 'negative';
                            const changeSymbol = change >= 0 ? '+' : '';
                            
                            indicesHTML += `
                                <div class="index-card" onclick="quickSearch('${index.symbol}')">
                                    <div class="index-name">${index.name}</div>
                                    <div class="index-value">$${data.price.toFixed(2)}</div>
                                    <div class="index-change ${changeClass}">
                                        ${changeSymbol}${Math.abs(change).toFixed(2)} (${changeSymbol}${Math.abs(data.changePercent).toFixed(2)}%)
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Error loading ${index.symbol}:`, error);
                    }
                }
                
                if (indicesHTML) {
                    indicesContainer.innerHTML = indicesHTML;
                }
                
                // Futures (using ETF proxies since Alpha Vantage doesn't have direct futures)
                const futures = [
                    {symbol: 'ES=F', name: 'ES (S&P FUTURES)', proxy: 'SPY'},
                    {symbol: 'NQ=F', name: 'NQ (NASDAQ FUTURES)', proxy: 'QQQ'}
                ];
                
                const futuresContainer = document.getElementById('futuresData');
                let futuresHTML = '';
                
                for (const future of futures) {
                    try {
                        const data = await getStockData(future.proxy);
                        if (data) {
                            const change = data.change;
                            const changeClass = change >= 0 ? 'positive' : 'negative';
                            const changeSymbol = change >= 0 ? '+' : '';
                            
                            futuresHTML += `
                                <div class="index-card">
                                    <div class="index-name">${future.name}</div>
                                    <div class="index-value">$${data.price.toFixed(2)}</div>
                                    <div class="index-change ${changeClass}">
                                        ${changeSymbol}${Math.abs(change).toFixed(2)} (${changeSymbol}${Math.abs(data.changePercent).toFixed(2)}%)
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Error loading ${future.symbol}:`, error);
                    }
                }
                
                if (futuresHTML) {
                    futuresContainer.innerHTML = futuresHTML;
                }
                
            } catch (error) {
                console.error('Market data error:', error);
                document.getElementById('majorIndices').innerHTML = '<div class="error">Unable to load market data</div>';
            }
        }

        function updateMarketStatus() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            let status = 'Closed';
            if (day >= 1 && day <= 5) {
                if (hour >= 9 && hour < 16) {
                    status = 'Open';
                } else if ((hour >= 4 && hour < 9) || (hour >= 16 && hour < 20)) {
                    status = 'Extended';
                }
            }
            
            document.getElementById('marketStatus').textContent = `Market ${status}`;
        }

        function isMarketOpen() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            return day >= 1 && day <= 5 && hour >= 9 && hour < 16;
        }

        // Utility functions
        function formatVolume(volume) {
            if (volume >= 1000000000) return (volume / 1000000000).toFixed(1) + 'B';
            if (volume >= 1000000) return (volume / 1000000).toFixed(1) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(1) + 'K';
            return volume.toString();
        }

        function showStockError(message) {
            const resultsContainer = document.getElementById('stockResults');
            resultsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // PWA install handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            deferredPrompt = e;
        });

        // Prevent zoom on iOS
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
