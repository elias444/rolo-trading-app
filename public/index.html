<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rolo AI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="application-name" content="Rolo AI">
    
    <link rel="manifest" href="data:application/json,{
        'name': 'Rolo AI Trading Assistant',
        'short_name': 'Rolo AI',
        'description': 'Professional AI Trading Assistant with Real-time Market Data',
        'start_url': '/?pwa=1',
        'scope': '/',
        'display': 'standalone',
        'orientation': 'portrait',
        'background_color': '#000000',
        'theme_color': '#007aff',
        'categories': ['finance', 'business', 'productivity'],
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'><text y=\\'.9em\\' font-size=\\'90\\'>ðŸ“ˆ</text></svg>',
                'sizes': 'any',
                'type': 'image/svg+xml'
            }
        ]
    }">

    <title>Rolo AI â€“ Stock Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: #f0f2f5; /* Light gray background, common in iOS apps */
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure body takes full viewport height */
            overflow: hidden; /* Prevent body scroll, let content scroll */
        }

        h1, h2, h3 {
            color: #2c2c2c; /* Darker text for titles */
            margin-top: 0;
        }

        .app-header {
            background: #ffffff;
            padding: 15px 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 0.5px solid #e0e0e0; /* Subtle line */
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #007aff; /* iOS blue */
            margin: 0;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            background: #ffffff;
            border-top: 0.5px solid #e0e0e0;
            padding: 8px 0;
            position: fixed; /* Fixed at bottom */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom); /* For iPhone X notch */
        }

        .tab-button {
            flex: 1;
            padding: 10px 0;
            background: none;
            color: #8e8e93; /* iOS gray for inactive tabs */
            border: none;
            font-size: 13px; /* Smaller font for tab labels */
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
        }

        .tab-button i {
            font-size: 20px; /* Icon size */
        }

        .tab-button.active {
            color: #007aff; /* iOS blue for active tab */
            font-weight: 600;
        }

        .tab-content-container {
            flex-grow: 1; /* Allow content to take available space */
            overflow-y: auto; /* Allow content to scroll */
            padding: 16px;
            padding-bottom: 70px; /* Space for the fixed tabs bar */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .tab-content {
            display: none;
            padding-bottom: 20px; /* Additional padding to prevent content being hidden by input */
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 12px;
            border: 0.5px solid #e0e0e0; /* Subtle border */
        }

        /* Chat specific styles */
        #chat-tab-content {
            display: flex;
            flex-direction: column;
            height: 100%; /* Take full height of parent container */
        }

        .chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #e5e5ea; /* Light gray chat background */
            border-radius: 0; /* No border radius for full height */
            padding-bottom: 100px; /* Space for the fixed input at the bottom */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling */
        }

        .message {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-end; /* Align bubbles to bottom if multi-line */
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 20px; /* More rounded */
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 16px;
        }

        .message.user .message-bubble {
            background-color: #007aff; /* iOS blue for user */
            color: white;
            border-bottom-right-radius: 4px; /* Pointy edge for user */
        }

        .message.assistant .message-bubble {
            background-color: #ffffff; /* White for assistant */
            color: #333;
            border: 1px solid #e0e0e0; /* Subtle border */
            border-bottom-left-radius: 4px; /* Pointy edge for assistant */
        }

        .chat-input-container {
            display: flex;
            padding: 10px 16px;
            background: #ffffff;
            border-top: 0.5px solid #e0e0e0;
            position: fixed; /* Fixed at the bottom */
            bottom: 56px; /* Adjust based on your tab bar height (e.g., 50px for tabs) */
            left: 0;
            right: 0;
            z-index: 999;
            box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* Adjust for notch */
        }

        #chatInput {
            flex-grow: 1;
            border: 1px solid #d1d1d6; /* iOS-like border */
            border-radius: 22px; /* Highly rounded */
            padding: 10px 16px;
            font-size: 16px;
            margin-right: 8px;
            outline: none;
            -webkit-appearance: none; /* Remove default styling */
            background-color: #f2f2f7; /* Light gray input background */
        }

        #sendButton {
            background: #007aff; /* iOS blue */
            color: white;
            border: none;
            border-radius: 22px; /* Highly rounded */
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.2s ease;
        }

        #sendButton:active {
            background-color: #0056b3; /* Darker blue on tap */
        }

        /* General input and button styles for consistency */
        input[type="text"], button {
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        input[type="text"] {
            border: 1px solid #d1d1d6;
            border-radius: 10px; /* Slightly rounded */
            padding: 10px 12px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
            -webkit-appearance: none;
            outline: none;
        }

        button:not(.tab-button):not(#sendButton) {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
            width: auto;
            display: inline-block;
            margin-top: 10px;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.2s ease;
        }

        button:not(.tab-button):not(#sendButton):active {
            background-color: #0056b3;
        }

        /* Loader/Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-top: 5px;
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #8e8e93;
            border-radius: 50%;
            margin: 0 2px;
            animation: pulse 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.7); opacity: 0.5; }
        }

        /* Card-like styles for content */
        .play-card, .alert-card {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border: 0.5px solid #e0e0e0;
        }
        .play-card h3, .alert-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 18px;
            color: #007aff;
        }
        .play-card p, .alert-card p {
            margin-bottom: 4px;
            font-size: 15px;
            line-height: 1.4;
        }
        .play-card strong, .alert-card strong {
            color: #2c2c2c;
        }
        .alert-card small {
            color: #8e8e93;
            font-size: 12px;
        }

        /* Ensure initial tab loads content */
        #chatContent.active,
        #tickerContent.active,
        #analysisContent.active,
        #playsContent.active,
        #marketContent.active,
        #alertsContent.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1 class="app-title">Rolo AI</h1>
    </div>

    <div class="tab-content-container">
        <div id="chatContent" class="tab-content active">
            <div id="chat-tab-content">
                <div class="chat-window" id="chatWindow">
                    <div class="message assistant">
                        <div class="message-bubble">Hello! I'm Rolo, your AI-powered trading assistant. I'm connected to live market data and ready to help you analyze stocks, find options plays, and learn your trading style. What would you like to explore today?</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tickerContent" class="tab-content">
            <h2>Stock Ticker</h2>
            <div class="section">
                <p>Enter a stock ticker to get real-time data:</p>
                <input type="text" id="tickerInput" placeholder="e.g., AAPL, TSLA, SPY">
                <button onclick="searchStock()">Get Data</button>
                <div id="tickerOutput" style="margin-top: 15px;">Search for a stock to get real-time data.</div>
            </div>
        </div>

        <div id="analysisContent" class="tab-content">
            <h2>Stock Analysis</h2>
            <div class="section">
                <div id="analysisOutput">No enhanced data available for analysis. Search a stock on the 'Ticker' tab first.</div>
            </div>
        </div>

        <div id="playsContent" class="tab-content">
            <h2>Smart Trading Plays</h2>
            <div class="section">
                <div id="smart-plays-output">No trading plays generated yet. Check back later, or ensure market conditions are active.</div>
                <button onclick="loadSmartPlays()">Refresh Plays</button>
            </div>
        </div>

        <div id="marketContent" class="tab-content">
            <h2>Market Dashboard</h2>
            <div class="section">
                <div id="marketDashboardOutput">Market dashboard will load here...</div>
                <button onclick="loadMarketDashboard()">Refresh Market</button>
            </div>
        </div>

        <div id="alertsContent" class="tab-content">
            <h2>Real-time Alerts</h2>
            <div class="section">
                <div id="alertsOutput">No real-time alerts.</div>
                <button onclick="loadSmartAlerts()">Refresh Alerts</button>
            </div>
        </div>
    </div>

    <div class="chat-input-container" id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="Ask Rolo AI...">
        <button id="sendButton" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab('chat', this)">
            <i class="fas fa-comments"></i>
            <span>Chat</span>
        </button>
        <button class="tab-button" onclick="openTab('ticker', this)">
            <i class="fas fa-chart-line"></i>
            <span>Ticker</span>
        </button>
        <button class="tab-button" onclick="openTab('analysis', this)">
            <i class="fas fa-brain"></i>
            <span>Analysis</span>
        </button>
        <button class="tab-button" onclick="openTab('plays', this)">
            <i class="fas fa-fire"></i>
            <span>Plays</span>
        </button>
        <button class="tab-button" onclick="openTab('market', this)">
            <i class="fas fa-globe"></i>
            <span>Market</span>
        </button>
        <button class="tab-button" onclick="openTab('alerts', this)">
            <i class="fas fa-bell"></i>
            <span>Alerts</span>
        </button>
    </div>

    <script>
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const tickerInput = document.getElementById('tickerInput');

        // Function to open tabs
        function openTab(tabName, element) {
            var i, tabContent, tabButtons;
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                tabContent[i].style.display = "none";
                tabContent[i].classList.remove("active");
            }
            tabButtons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            document.getElementById(tabName + "Content").style.display = "block";
            document.getElementById(tabName + "Content").classList.add("active");
            element.classList.add("active");

            // Load content dynamically when tab is opened
            if (tabName === 'market') {
                loadMarketDashboard();
            } else if (tabName === 'plays') {
                loadSmartPlays();
            } else if (tabName === 'alerts') {
                loadSmartAlerts();
            }
            // For chat, ensure scroll to bottom
            if (tabName === 'chat') {
                scrollToBottom();
            }
        }

        // Scroll chat window to bottom
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Display message in chat window
        function displayMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('message-bubble');
            // Basic markdown-like formatting for bold
            bubbleDiv.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.appendChild(bubbleDiv);
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        // Send message to Rolo AI
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;

            displayMessage('user', message);
            chatInput.value = ''; // Clear input field

            // Add typing indicator
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.classList.add('message', 'assistant', 'typing-indicator-container');
            typingIndicatorDiv.innerHTML = `
                <div class="message-bubble typing-indicator">
                    <span></span><span></span><span></span>
                </div>`;
            chatWindow.appendChild(typingIndicatorDiv);
            scrollToBottom();

            try {
                // Call the enhanced-rolo-chat Netlify function
                const response = await fetch('/.netlify/functions/enhanced-rolo-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                // Remove typing indicator
                chatWindow.removeChild(typingIndicatorDiv);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayMessage('assistant', data.response); // Display Rolo AI's response

            } catch (error) {
                console.error('Error sending message:', error);
                // Remove typing indicator if error occurs during fetch
                const existingTypingIndicator = chatWindow.querySelector('.typing-indicator-container');
                if (existingTypingIndicator) {
                    chatWindow.removeChild(existingTypingIndicator);
                }
                displayMessage('assistant', `<span style="color: red;">Rolo AI is experiencing an issue: ${error.message}. Please try again later. Make sure your Gemini API key is configured in Netlify.</span>`);
            }
        }

        // Search Stock function (Ticker Tab)
        async function searchStock() {
            const symbol = tickerInput.value.toUpperCase().trim();
            const tickerOutput = document.getElementById('tickerOutput');

            if (!symbol) {
                tickerOutput.innerHTML = '<p style="color: orange;">Please enter a stock ticker.</p>';
                return;
            }

            tickerOutput.innerHTML = `<p>Loading ${symbol} data...</p>`; // Loading indicator

            try {
                // Calls your smart-stock-data.js Netlify function
                const response = await fetch(`/.netlify/functions/smart-stock-data?symbol=${symbol}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Stock data received:', data); // Log the data

                let html = `
                    <h3>${data.symbol} - $${data.price}</h3>
                    <p>Change: <span style="color: ${data.change >= 0 ? 'green' : 'red'};">${data.change} (${data.changePercent})</span></p>
                    <p>Volume: ${data.volume}</p>
                    <p>High: $${data.high} | Low: $${data.low}</p>
                    <p>Open: $${data.open} | Previous Close: $${data.previousClose}</p>
                    <p>Last Updated: ${data.lastUpdated}</p>
                    <p><small>Source: ${data.source}</small></p>
                `;
                tickerOutput.innerHTML = html;

                // Immediately update analysis tab with fetched data
                updateAnalysisTab(data.symbol, data);

            } catch (error) {
                console.error('Error fetching stock data:', error);
                tickerOutput.innerHTML = `<p style="color: red;">Error fetching data for ${symbol}: ${error.message}. Please ensure your Alpha Vantage API key is configured in Netlify.</p>`;
            }
        }

        // Update Analysis Tab
        function updateAnalysisTab(ticker, data) {
            const analysisOutput = document.getElementById('analysisOutput');
            
            if (!data.price) {
                analysisOutput.innerHTML = 'No enhanced data available for analysis. Search a stock on the \'Ticker\' tab first.';
                return;
            }
            
            let analysisHtml = `<h3>${ticker} Enhanced Analysis</h3><div class="section">`;
            
            // Basic example analysis based on available data
            analysisHtml += `<p>Current Price: <strong>$${data.price}</strong></p>`;
            analysisHtml += `<p>Daily Change: <span style="color: ${data.change >= 0 ? 'green' : 'red'};"><strong>${data.change} (${data.changePercent})</strong></span></p>`;
            analysisHtml += `<p>Volume: <strong>${data.volume}</strong></p>`;

            // Simple performance assessment
            if (parseFloat(data.change) > 0) {
                analysisHtml += `<p><strong>Outlook:</strong> Bullish momentum detected today. Price is up with strong volume.</p>`;
            } else if (parseFloat(data.change) < 0) {
                analysisHtml += `<p><strong>Outlook:</strong> Bearish pressure observed today. Price is down.</p>`;
            } else {
                analysisHtml += `<p><strong>Outlook:</strong> Neutral today. Price is relatively stable.</p>`;
            }

            // Placeholder for more advanced analysis
            analysisHtml += `<p><em>Further technical indicators (RSI, MACD, Support/Resistance) and sentiment analysis will be integrated here once advanced backend functions are fully deployed and providing data.</em></p>`;
            analysisHtml += `</div>`;
            analysisOutput.innerHTML = analysisHtml;
        }

        // Load Market Dashboard function (Market Tab)
        async function loadMarketDashboard() {
            const marketDashboardOutput = document.getElementById('marketDashboardOutput');
            marketDashboardOutput.innerHTML = `<p>Loading live market data...</p>`; // Loading indicator

            try {
                // Calls your market-dashboard.js Netlify function
                const response = await fetch(`/.netlify/functions/market-dashboard`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Market data received:', data);

                let html = `<h3>Major Indices</h3>`;
                html += `<div class="section">`;
                if (data.spy) {
                    html += `<p><strong>S&P 500 (SPY):</strong> $${data.spy.price} <span style="color: ${data.spy.change >= 0 ? 'green' : 'red'};">(${data.spy.changePercent})</span></p>`;
                }
                if (data.qqq) {
                    html += `<p><strong>NASDAQ (QQQ):</strong> $${data.qqq.price} <span style="color: ${data.qqq.change >= 0 ? 'green' : 'red'};">(${data.qqq.changePercent})</span></p>`;
                }
                if (data.dia) {
                    html += `<p><strong>DOW JONES (DIA):</strong> $${data.dia.price} <span style="color: ${data.dia.change >= 0 ? 'green' : 'red'};">(${data.dia.changePercent})</span></p>`;
                }
                if (data.vix) {
                    html += `<p><strong>VIX (Fear Index):</strong> $${data.vix.price} <span style="color: ${data.vix.change >= 0 ? 'red' : 'green'};">(${data.vix.changePercent})</span></p>`;
                }
                html += `</div>`;

                html += `<h3>Futures</h3>`;
                html += `<div class="section">`;
                if (data.futures && data.futures.ES) {
                    html += `<p><strong>ES (S&P Futures):</strong> $${data.futures.ES.price} <span style="color: ${data.futures.ES.change >= 0 ? 'green' : 'red'};">(${data.futures.ES.changePercent})</span></p>`;
                }
                if (data.futures && data.futures.NQ) {
                    html += `<p><strong>NQ (NASDAQ Futures):</strong> $${data.futures.NQ.price} <span style="color: ${data.futures.NQ.change >= 0 ? 'green' : 'red'};">(${data.futures.NQ.changePercent})</span></p>`;
                }
                html += `</div>`;

                marketDashboardOutput.innerHTML = html;

            } catch (error) {
                console.error('Error loading market dashboard:', error);
                marketDashboardOutput.innerHTML = `<p style="color: red;">Error loading market data: ${error.message}. Please ensure your Alpha Vantage API key is configured.</p>`;
            }
        }

        // Load Smart Plays function (Plays Tab)
        async function loadSmartPlays() {
            const smartPlaysOutput = document.getElementById('smart-plays-output');
            smartPlaysOutput.innerHTML = `<p>Generating smart trading plays...</p>`; // Loading indicator

            try {
                // Calls your smart-plays-generator.js Netlify function
                const response = await fetch(`/.netlify/functions/smart-plays-generator`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Smart plays received:', data);

                let html = '';
                if (data.plays && data.plays.length > 0) {
                    data.plays.forEach(play => {
                        html += `
                            <div class="section play-card">
                                <h3>${play.emoji || 'ðŸ’¡'} ${play.title}</h3>
                                <p><strong>Ticker:</strong> ${play.ticker || 'N/A'}</p>
                                <p><strong>Strategy:</strong> ${play.strategy || 'N/A'}</p>
                                <p><strong>Description:</strong> ${play.description || 'No description provided.'}</p>
                                <p><strong>Confidence:</strong> ${play.confidence || 'N/A'}% | <strong>Risk:</strong> ${play.risk_level || 'N/A'}</p>
                                <p><strong>Timeframe:</strong> ${play.timeframe || 'N/A'}</p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No trading plays generated yet. Check back later, or ensure market conditions are active. If this persists, verify your Alpha Vantage API key.</p>';
                }
                smartPlaysOutput.innerHTML = html;

            } catch (error) {
                console.error('Error loading smart plays:', error);
                smartPlaysOutput.innerHTML = `<p style="color: red;">Error generating smart plays: ${error.message}. Please ensure your Alpha Vantage API key is configured in Netlify.</p>`;
            }
        }

        // Load Smart Alerts function (Alerts Tab)
        async function loadSmartAlerts() {
            const alertsOutput = document.getElementById('alertsOutput');
            alertsOutput.innerHTML = `<p>Checking for real-time alerts...</p>`; // Loading indicator

            try {
                // Calls your realtime-alerts.js Netlify function
                const response = await fetch(`/.netlify/functions/realtime-alerts`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Alerts received:', data);

                let html = '';
                if (data.alerts && data.alerts.length > 0) {
                    data.alerts.forEach(alert => {
                        html += `
                            <div class="section alert-card">
                                <h3>${alert.title} <span style="font-size: 0.8em; color: gray;">(${alert.priority || 'medium'})</span></h3>
                                <p>${alert.description || 'No description provided.'}</p>
                                <p><strong>Action:</strong> ${alert.action || 'No action specified.'}</p>
                                <small>${new Date(alert.timestamp).toLocaleString()}</small>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>No real-time alerts at the moment. The market might be calm, or your watchlist is empty. If this persists, verify your Alpha Vantage API key.</p>';
                }
                alertsOutput.innerHTML = html;

            } catch (error) {
                console.error('Error loading smart alerts:', error);
                alertsOutput.innerHTML = `<p style="color: red;">Error fetching alerts: ${error.message}. Please ensure your Alpha Vantage API key is configured in Netlify.</p>`;
            }
        }

        // Event listeners
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        document.getElementById('tickerInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        // Initialize with Chat tab active and scroll to bottom
        document.addEventListener('DOMContentLoaded', () => {
            openTab('chat', document.querySelector('.tab-button.active'));
            scrollToBottom();
        });
        
    </script>
</body>
</html>
